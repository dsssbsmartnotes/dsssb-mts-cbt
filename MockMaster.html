<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DSSSB CBT Professional Portal</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* =========================
   CORE VARIABLES & THEME
   ========================= */
:root {
  --primary: #2196f3;
  --primary-dark: #1976d2;
  --success: #2e7d32;
  --danger: #c62828;
  --warning: #f9a825;
  --locked: #9e9e9e;
  
  --bg-body: #f5f7fa;
  --bg-card: #ffffff;
  --text-main: #333333;
  --text-muted: #555555;
  --border-color: #dddddd;
  --header-bg: #ffffff;
  --section-bar-bg: #e3f2fd;
  --opt-hover: #f0f7ff;
  --opt-sel-bg: #e3f2fd;
  --palette-bg: #ffffff;
  --zoom-bg: rgba(255, 255, 255, 0.95);
  
  --font-base: 16px;
}

/* Dark Mode Overrides */
body.dark-mode {
  --primary: #64b5f6;
  --primary-dark: #42a5f5;
  --success: #66bb6a;
  --danger: #ef5350;
  
  --bg-body: #121212;
  --bg-card: #1e1e1e;
  --text-main: #e0e0e0;
  --text-muted: #b0b0b0;
  --border-color: #333333;
  --header-bg: #1e1e1e;
  --section-bar-bg: #263238;
  --opt-hover: #2c3e50;
  --opt-sel-bg: #1565c0;
  --palette-bg: #1e1e1e;
  --zoom-bg: rgba(0, 0, 0, 0.9);
}

html, body {
  width: 100%; margin: 0; padding: 0;
  overflow-x: hidden; font-family: 'Segoe UI', Arial, sans-serif;
  background: var(--bg-body); color: var(--text-main);
  height: 100%;
  transition: background 0.3s, color 0.3s;
  user-select: none;
}

body { display: grid; grid-template-rows: auto auto 1fr auto; height: 100vh; }

/* SCREENS */
.full-screen-overlay {
  position: fixed; inset: 0; background: var(--bg-body);
  z-index: 2000; display: flex; flex-direction: column;
  justify-content: center; align-items: center; padding: 20px;
}
.start-card {
  background: var(--bg-card); padding: 30px; border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2); width: 100%; max-width: 500px;
  border: 1px solid var(--border-color); text-align: center;
}
.inst-list { text-align: left; margin: 15px 0; font-size: 14px; line-height: 1.6; color: var(--text-main); }
.start-input {
  width: 90%; padding: 12px; margin: 10px 0;
  border: 2px solid var(--border-color); border-radius: 6px;
  font-size: 16px; background: var(--bg-body); color: var(--text-main);
}
.primary-btn {
  background: var(--primary); color: #fff; border: none; padding: 12px 30px;
  font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer;
  transition: 0.2s; width: 100%; margin-top: 10px;
}
.primary-btn:disabled { background: #999; cursor: not-allowed; }
.secondary-btn {
    background: transparent; color: var(--text-muted); border: 2px solid var(--border-color);
    margin-top: 10px; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold;
}

/* HEADER */
header {
  background: var(--header-bg); padding: 10px 15px;
  display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 20;
  border-bottom: 1px solid var(--border-color);
}
.brand { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
.tools { display: flex; gap: 8px; }
.tool-btn {
  background: var(--bg-body); border: 1px solid var(--border-color); 
  padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;
  font-weight: 600; color: var(--text-main);
}

/* SECTION BAR (UPDATED FOR LOCKS) */
#sectionBar {
  background: var(--section-bar-bg); display: flex; overflow-x: auto;
  white-space: nowrap; box-shadow: inset 0 -1px 2px rgba(0,0,0,0.1);
  scrollbar-width: none;
}
.sec-tab {
  padding: 12px 16px; font-size: 14px; font-weight: 600;
  color: var(--text-muted); cursor: not-allowed; opacity: 0.6;
  border-bottom: 3px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 5px;
}
.sec-tab.active {
  color: var(--primary); border-bottom-color: var(--primary);
  background: rgba(33, 150, 243, 0.1); opacity: 1; cursor: default;
}
.sec-tab.done {
  color: var(--success); border-bottom-color: var(--success); opacity: 0.8;
}
.sec-tab.locked {
  color: var(--text-muted);
}

/* MAIN */
#mainArea { padding: 10px; overflow-y: auto; position: relative; padding-bottom: 80px; display: none; }
.card {
  background: var(--bg-card); padding: 16px; border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
  font-size: var(--font-base); border: 1px solid var(--border-color);
  color: var(--text-main);
}
.q-img { max-width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: 4px; margin: 10px 0; cursor: zoom-in; display: block; }
.opt {
  border: 1px solid var(--border-color); padding: 12px 15px;
  margin: 8px 0; border-radius: 6px; cursor: pointer;
  transition: background 0.15s; display: flex; align-items: center;
  color: var(--text-main);
}
.opt:hover { background: var(--opt-hover); border-color: var(--primary); }
.opt.sel { background: var(--opt-sel-bg); border-color: var(--primary); font-weight: 600; }
.opt.correct { background: rgba(46, 125, 50, 0.2); border-color: var(--success); }
.opt.wrong { background: rgba(198, 40, 40, 0.2); border-color: var(--danger); }
.opt-circle {
  width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted);
  margin-right: 12px; display: flex; align-items: center; justify-content: center;
  font-size: 10px; color: var(--text-main);
}
.opt.sel .opt-circle { border-color: var(--primary); background: var(--primary); color: #fff; }

/* FOOTER */
footer {
  background: var(--bg-card); padding: 10px; border-top: 1px solid var(--border-color);
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
  position: fixed; bottom: 0; width: 100%;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: none;
}
.nav-btn {
  padding: 12px; border: none; border-radius: 6px;
  font-weight: bold; color: #fff; cursor: pointer; font-size: 14px;
}
.btn-prev { background: #757575; }
.btn-next { background: var(--primary); }
.btn-submit-sec { background: var(--success); grid-column: span 1; animation: pulse 2s infinite; }
.btn-submit-test { background: var(--danger); }

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

/* PALETTE */
#palettePanel {
  position: fixed; top: 0; right: -100%; width: 85%; max-width: 320px;
  height: 100%; background: var(--palette-bg); z-index: 100;
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: -5px 0 25px rgba(0,0,0,0.2);
  display: flex; flex-direction: column; color: var(--text-main);
}
#palettePanel.show { right: 0; }
.p-grid { padding: 15px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; align-content: start; }
.qbtn {
  aspect-ratio: 1; border-radius: 50%; border: none; font-weight: bold; font-size: 12px;
  cursor: pointer; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
}
.qbtn.current { box-shadow: 0 0 0 2px var(--text-main); transform: scale(1.1); }
.qbtn.answered { background: var(--success); color: #fff; border: none; }
.qbtn.visited { background: var(--bg-body); border-color: #bbb; } 
.qbtn.review { background: var(--primary-dark); color: #fff; }

/* EXTRAS */
#timer { background: var(--bg-card); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: var(--danger); border: 1px solid var(--danger); }
#expBox { margin-top: 15px; padding: 15px; background: rgba(46, 125, 50, 0.1); border-left: 4px solid var(--success); display: none; color: var(--text-main); border-radius: 4px; }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
.overlay.show { display: block; }

#tgPopup {
 position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
 background: var(--bg-card); padding:25px; width:85%; max-width:320px;
 border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.4);
 z-index:9999; text-align:center; display:none; color: var(--text-main);
 border: 1px solid var(--border-color);
}
#tgPopup a { display:block; background:#0088cc; color:#fff; padding:12px; border-radius:8px; text-decoration:none; margin-top:15px; font-weight:bold; }
#qpModal { position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: var(--bg-card); color: var(--text-main); z-index: 200; border-radius: 8px; display: none; flex-direction: column; border: 1px solid var(--border-color); }
#zoomModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--zoom-bg); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column; }
#zoomImg { max-width: 90%; max-height: 85vh; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: 1px solid #fff; }

/* Result PDF Styling */
.result-q-box { margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); page-break-inside: avoid; }
.res-opt { padding: 5px; margin: 2px 0; border-radius: 4px; font-size: 14px; }
.res-opt.c { background: rgba(46, 125, 50, 0.2); border: 1px solid var(--success); }
.res-opt.w { background: rgba(198, 40, 40, 0.2); border: 1px solid var(--danger); text-decoration: line-through; }

@media(min-width: 768px) {
  body { grid-template-columns: 1fr 300px; grid-template-rows: auto auto 1fr; }
  header { grid-column: 1 / -1; }
  #sectionBar { grid-column: 1 / 2; }
  #mainArea { grid-column: 1 / 2; grid-row: 3 / 4; padding-bottom: 20px; }
  #palettePanel { position: static; width: auto; height: auto; right: auto; grid-column: 2 / 3; grid-row: 2 / 4; border-left: 1px solid var(--border-color); box-shadow: none; z-index: 1; }
  footer { grid-column: 1 / 2; position: static; display: flex; justify-content: space-between; box-shadow: none; border-top: 1px solid var(--border-color); }
  .btn-palette { display: none; } 
  .p-grid { grid-template-columns: repeat(4, 1fr); }
  #qpModal { width: 60%; left: 20%; }
}
</style>
</head>

<body onload="initApp()">

<div id="zoomModal" onclick="closeZoom()"><span style="position:absolute; top:20px; right:20px; font-size:40px; color:var(--text-main); cursor:pointer;">&times;</span><img id="zoomImg" src=""><div style="color:var(--text-main); margin-top:10px;">Click anywhere to close</div></div>
<div class="overlay" onclick="togglePalette()" id="bgOverlay"></div>

<div id="startScreen" class="full-screen-overlay">
    <div class="start-card">
        <h2 style="color:var(--primary); margin-top:0;">DSSSB Professional Portal</h2>
        <p style="color:var(--text-muted); margin-bottom:5px;">Enter Details to Login</p>
        <input type="text" id="startNameInput" class="start-input" placeholder="Full Name">
        <input type="password" id="examPassInput" class="start-input" placeholder="Password (Ask Admin)" autocomplete="off">
        <button class="primary-btn" onclick="goToInstructions()">LOGIN</button>
    </div>
</div>

<div id="instScreen" class="full-screen-overlay" style="display:none;">
    <div class="start-card" style="max-width:600px; text-align:left;">
        <h3 style="color:var(--primary); border-bottom:1px solid var(--border-color); padding-bottom:10px;">Test Rules (Strict)</h3>
        <div class="inst-list">
            <b>1. Anti-Cheating:</b> <span style="color:var(--danger)">Do NOT switch tabs. Test will auto-submit after 3 warnings.</span><br>
            <b>2. Sectional Logic:</b> You must SUBMIT the current section to unlock the next. <u>You cannot go back.</u><br>
            <b>3. Timer:</b> Reverse timer (60 Mins). Test submits at 00:00.
        </div>
        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600; font-size:14px; margin-top:20px;">
            <input type="checkbox" id="instCheck" onchange="toggleStartBtn()" style="width:20px; height:20px; margin-right:10px;">
            I agree to the rules.
        </label>
        <br>
        <button id="finalStartBtn" class="primary-btn" onclick="startTestFlow()" disabled>START EXAM</button>
    </div>
</div>

<div id="tgPopup">
 <b>üì¢ Join DSSSB Smart Notes</b><br><br>Daily Tests ‚Ä¢ PDFs ‚Ä¢ Results<br>
 <a href="https://t.me/DSSSBSmartNotes" target="_blank">Join Telegram</a><br>
 <button style="margin-top:15px; padding:8px 20px; background:var(--bg-body); border:1px solid var(--border-color); border-radius:4px; cursor:pointer;" onclick="closeTg()">Continue Test</button>
</div>

<header>
  <div class="brand">DSSSB CBT <span style="font-size:0.8em; color:var(--text-muted)">Secure</span></div>
  <div style="display:flex; align-items:center; gap:10px;">
    <div id="timer">60:00</div>
    <button class="tool-btn" onclick="toggleDarkMode()" id="themeBtn">üåô</button>
    <button class="tool-btn" onclick="toggleLang()" id="langBtn">EN/HI</button>
    <button class="tool-btn" onclick="openQP()">üìÑ Paper</button>
  </div>
</header>

<div id="sectionBar"></div>

<div id="mainArea">
  <input type="hidden" id="stuName">
  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:var(--text-muted); font-size:13px;">
      <span>Q. <b id="qNumDisp">1</b></span>
      <span style="display:flex; gap:10px;"><span style="color:var(--success)">+1.0</span><span style="color:var(--danger)">-0.25</span></span>
    </div>
    <div style="font-size:14px; text-align:right; margin-bottom:5px;">
        <button class="tool-btn" onclick="changeFont(1)">A+</button> <button class="tool-btn" onclick="changeFont(-1)">A-</button>
    </div>
    <div id="qContent"></div> 
    <div id="opts"></div>      
    <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
        <button class="tool-btn" style="color:orange; border:1px solid orange; background:var(--bg-card)" onclick="markReview()">‚≠ê Review</button>
        <button class="tool-btn" onclick="clearResponse()">Clear</button>
    </div>
    <div id="expBox"></div>
  </div>
</div>

<div id="palettePanel">
  <div class="p-header"><b>Palette</b> <button onclick="togglePalette()" class="close-pal" style="border:none;background:none;font-size:20px;">&times;</button></div>
  <div style="padding:10px; font-size:12px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
    <div><span style="color:var(--success)">‚ñ†</span> Ans</div> <div><span style="color:var(--text-muted)">‚ñ†</span> Skip</div>
    <div><span style="color:var(--primary)">‚ñ†</span> Review</div> <div><span style="color:#999">‚ñ†</span> Locked</div>
  </div>
  <div class="p-grid" id="paletteGrid"></div>
  <div class="p-footer"><button id="mainSubmitBtn" onclick="submitTest()" class="btn-submit-test" style="width:100%; padding:12px; color:#fff; border:none; border-radius:4px; font-weight:bold; display:none;">FINISH EXAM</button></div>
</div>

<footer>
  <button class="nav-btn btn-palette" onclick="togglePalette()">Grid</button>
  <button class="nav-btn btn-prev" onclick="prev()">Previous</button>
  <button class="nav-btn btn-next" id="nextBtn" onclick="next()">Next</button>
</footer>

<div id="qpModal">
    <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"><b id="modalTitle">Question Paper</b><button onclick="closeQP()" style="border:none; background:none; font-size:20px;">&times;</button></div>
    <div id="qpContent" style="padding:20px; overflow-y:auto; flex:1;"></div>
</div>

<script>
/* =========================================
   CONFIG & DATA
   ========================================= */
const EXAM_PASSWORD = "12345"; 
const TOTAL_TIME_MINS = 60; // 60 Minutes
const TELEGRAM_BOT_TOKEN="8486464606:AAFT_Bd0P2HYqKNPjCm3s7TGgfM4HWmOYvs";
const TELEGRAM_CHAT_ID="@dsssbcbtresult";
const SECTIONS = ["Reasoning", "GK", "Maths", "English", "Hindi"];
const NEGATIVE_MARK = 0.25;

/* QUESTIONS */
const QUESTIONS = [
  { id: 1, section: "Reasoning", q_hi: "‡§®‡•Ä‡§ö‡•á ‡§¶‡•Ä ‡§ó‡§à ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§Æ‡•á‡§Ç ‡§Ö‡§ó‡§≤‡§æ ‡§™‡§¶ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§ó‡§æ? 2, 5, 11, 23, ?", q_en: "What is the next term in the series? 2, 5, 11, 23, ?", o_hi: ["44", "47", "50", "46"], o_en: ["44", "47", "50", "46"], a: 1, e_hi: "‡§§‡§∞‡•ç‡§ï: x2 + 1. (2x2+1=5, 5x2+1=11...). 23x2+1 = 47." },
  { id: 2, section: "Reasoning", q_hi: "‡§µ‡§ø‡§∑‡§Æ ‡§∂‡§¨‡•ç‡§¶ ‡§ö‡•Å‡§®‡•á‡§Ç:", q_en: "Find the odd word:", o_hi: ["‡§∏‡•á‡§¨", "‡§ó‡•á‡§Ç‡§¶", "‡§ï‡§Æ‡§≤", "‡§ó‡•Å‡§≤‡§æ‡§¨"], o_en: ["Apple", "Ball", "Lotus", "Rose"], a: 1, e_hi: "‡§ó‡•á‡§Ç‡§¶ ‡§è‡§ï ‡§ñ‡•á‡§≤ ‡§ï‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å ‡§π‡•à, ‡§¨‡§æ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§π‡•à‡§Ç‡•§" },
  { id: 3, section: "GK", q_hi: "‡§≠‡§æ‡§∞‡§§ ‡§ï‡•á ‡§∏‡§Ç‡§µ‡§ø‡§ß‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§Æ‡•å‡§≤‡§ø‡§ï ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø ‡§ï‡§ø‡§∏ ‡§¶‡•á‡§∂ ‡§∏‡•á ‡§≤‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç?", q_en: "Fundamental Duties in Indian Constitution are borrowed from?", o_hi: ["USA", "Russia (USSR)", "Canada", "UK"], o_en: ["USA", "Russia (USSR)", "Canada", "UK"], a: 1, e_hi: "‡§Æ‡•å‡§≤‡§ø‡§ï ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø ‡§∏‡•ã‡§µ‡§ø‡§Ø‡§§ ‡§∏‡§Ç‡§ò (USSR) ‡§∏‡•á ‡§≤‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§" },
  { id: 4, section: "Maths", q_hi: "‡§Ø‡§¶‡§ø ‡§ï‡•ç‡§∞‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‚Çπ800 ‡§π‡•à ‡§î‡§∞ ‡§≤‡§æ‡§≠ 25% ‡§π‡•à, ‡§§‡•ã ‡§µ‡§ø‡§ï‡•ç‡§∞‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?", q_en: "If CP is ‚Çπ800 and Profit is 25%, find SP.", o_hi: ["‚Çπ900", "‚Çπ1000", "‚Çπ1100", "‚Çπ1200"], o_en: ["‚Çπ900", "‚Çπ1000", "‚Çπ1100", "‚Çπ1200"], a: 1, e_hi: "$$ SP = 800 \\times \\frac{125}{100} = 800 \\times 1.25 = 1000 $$" },
  { id: 5, section: "English", q_en: `<div class="passage-box"><b>Passage:</b><br>Pollution is rising. We must plant trees.</div><br>What must we do?`, q_hi: `<div class="passage-box"><b>‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂:</b><br>‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§¨‡§¢‡§º ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§π‡§Æ‡•á‡§Ç ‡§™‡•á‡§°‡§º ‡§≤‡§ó‡§æ‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è‡•§</div><br>‡§π‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?`, o_en: ["Cut trees", "Plant trees", "Sleep", "Drive cars"], o_hi: ["‡§™‡•á‡§°‡§º ‡§ï‡§æ‡§ü‡•á‡§Ç", "‡§™‡•á‡§°‡§º ‡§≤‡§ó‡§æ‡§è‡§Å", "‡§∏‡•ã ‡§ú‡§æ‡§è‡§Ç", "‡§ó‡§æ‡§°‡§º‡•Ä ‡§ö‡§≤‡§æ‡§è‡§Ç"], a: 1, e_hi: "Passage clearly states we must plant trees." },
  { id: 6, section: "Hindi", q_hi: " '‡§®‡§Ø‡§æ ‡§®‡•å ‡§¶‡§ø‡§® ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§∏‡•å ‡§¶‡§ø‡§®' ‡§≤‡•ã‡§ï‡•ã‡§ï‡•ç‡§§‡§ø ‡§ï‡§æ ‡§∏‡§π‡•Ä ‡§Ö‡§∞‡•ç‡§• ‡§π‡•à?", q_en: "", o_hi: ["‡§®‡§à ‡§ö‡•Ä‡§ú ‡§Ö‡§ö‡•ç‡§õ‡•Ä", "‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ö‡•Ä‡§ú ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø", "‡§¶‡•ã‡§®‡•ã‡§Ç ‡§¨‡•á‡§ï‡§æ‡§∞", "‡§Æ‡§π‡§Ç‡§ó‡•Ä ‡§ö‡•Ä‡§ú"], a: 1, e_hi: "‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ö‡•Ä‡§ú‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡§Ç‡•§" },
  
  // Image Example
  {
      id: 7, section: "Reasoning",
      q_hi: "‡§®‡•Ä‡§ö‡•á ‡§¶‡•Ä ‡§ó‡§à ‡§Ü‡§ï‡•É‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§§‡§®‡•á ‡§§‡•ç‡§∞‡§ø‡§≠‡•Å‡§ú ‡§π‡•à‡§Ç?<br><img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' alt='Base64 Image' style='border:1px solid #ccc'>",
      q_en: "How many triangles are in the figure below?<br><img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' alt='Base64 Image' style='border:1px solid #ccc'>",
      o_hi: ["10", "12", "14", "16"],
      o_en: ["10", "12", "14", "16"],
      a: 1,
      e_hi: "‡§Ü‡§ï‡•É‡§§‡§ø ‡§ï‡•ã ‡§ó‡§ø‡§®‡§®‡•á ‡§™‡§∞ 12 ‡§§‡•ç‡§∞‡§ø‡§≠‡•Å‡§ú ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç‡•§"
  }
];

/* STATE */
let currentIdx = 0;
let currentLang = "HI";
let answers = new Array(QUESTIONS.length).fill(null);
let reviewStatus = new Array(QUESTIONS.length).fill(false);
let submitted = false;
let timeLeft = TOTAL_TIME_MINS * 60; // In Seconds
let fontSize = 16;
let isDarkMode = false;
let timerInterval;
let warningCount = 0;

// SECTIONAL LOGIC VARS
let activeSectionIndex = 0; // Starts at 0
let sectionStartIndices = [];
let sectionEndIndices = [];

/* --- INIT --- */
function initApp() {
    if(localStorage.getItem('dsssb_dark_mode') === 'true') toggleDarkMode();
    calcSectionIndices();
    document.getElementById('startScreen').style.display = 'flex';
}

function calcSectionIndices() {
    // Map start and end indices for each section
    SECTIONS.forEach(sec => {
        const start = QUESTIONS.findIndex(q => q.section === sec);
        // Find last index of this section
        let end = start;
        for(let i=start; i<QUESTIONS.length; i++){
            if(QUESTIONS[i].section === sec) end = i;
            else if(end > start) break;
        }
        sectionStartIndices.push(start);
        sectionEndIndices.push(end);
    });
}

function goToInstructions() {
    const name = document.getElementById('startNameInput').value.trim();
    const pass = document.getElementById('examPassInput').value.trim();
    if(!name) { alert("Enter Name"); return; }
    if(pass !== EXAM_PASSWORD) { alert("‚ùå WRONG PASSWORD"); return; }
    document.getElementById('stuName').value = name;
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('instScreen').style.display = 'flex';
}

function toggleStartBtn() { document.getElementById('finalStartBtn').disabled = !document.getElementById('instCheck').checked; }

function startTestFlow() { 
    document.getElementById('instScreen').style.display = 'none'; 
    document.getElementById('mainArea').style.display = 'block';
    document.querySelector('footer').style.display = 'flex';
    document.getElementById('tgPopup').style.display = "block";
    
    // Start at first section
    currentIdx = sectionStartIndices[0];
    renderSectionTabs(); 
    loadQuestion(currentIdx); 
    startTimer();
    startAntiCheat();
}

/* --- CORE LOGIC --- */
function renderSectionTabs() {
    const bar = document.getElementById('sectionBar');
    let html = "";
    SECTIONS.forEach((sec, i) => {
        let cls = "sec-tab";
        let icon = "üîí";
        
        if (i === activeSectionIndex) { cls += " active"; icon = "üü¢"; } // Current
        else if (i < activeSectionIndex) { cls += " done"; icon = "‚úÖ"; } // Completed
        
        html += `<div class="${cls}">${icon} ${sec}</div>`;
    });
    bar.innerHTML = html;
}

function loadQuestion(idx) {
    currentIdx = idx;
    const q = QUESTIONS[idx];
    document.getElementById('qNumDisp').innerText = idx + 1;
    
    // Render Text
    const contentDiv = document.getElementById('qContent');
    const txt = (currentLang==="HI" && q.q_hi) ? q.q_hi : (q.q_en||q.q_hi);
    contentDiv.innerHTML = txt;
    contentDiv.style.fontSize = fontSize + "px";
    
    // Zoom Images
    contentDiv.querySelectorAll('img').forEach(img => { img.classList.add('q-img'); img.onclick=()=>openZoom(img.src); });

    // Options
    const optsArr = (currentLang==="HI" && q.o_hi) ? q.o_hi : (q.o_en||q.o_hi);
    let html = "";
    optsArr.forEach((opt, i) => {
        let cls = "opt";
        if(submitted) { if(i===q.a) cls+=" correct"; else if(answers[idx]===i) cls+=" wrong"; }
        else if(answers[idx]===i) cls+=" sel";
        html += `<div class="${cls}" onclick="selectAnswer(${i})"><div class="opt-circle">${String.fromCharCode(65+i)}</div><div>${opt}</div></div>`;
    });
    document.getElementById('opts').innerHTML = html;

    // Explanation (If submitted)
    if(submitted) {
       const e = (currentLang==="HI" && q.e_hi) ? q.e_hi : (q.e_en||q.e_hi);
       document.getElementById('expBox').innerHTML = "<b>Exp:</b> "+e;
       document.getElementById('expBox').style.display="block";
    }

    // UPDATE NAVIGATION BUTTONS
    const nextBtn = document.getElementById('nextBtn');
    const isLastInSec = (currentIdx === sectionEndIndices[activeSectionIndex]);
    
    if(submitted) {
        nextBtn.innerText = "Next"; 
        nextBtn.className = "nav-btn btn-next";
        nextBtn.onclick = () => { if(currentIdx < QUESTIONS.length-1) loadQuestion(currentIdx+1); };
    } else {
        if (isLastInSec) {
            // End of Section -> Show Submit Section Button
            if (activeSectionIndex < SECTIONS.length - 1) {
                nextBtn.innerText = `Submit ${SECTIONS[activeSectionIndex]}`;
                nextBtn.className = "nav-btn btn-submit-sec";
                nextBtn.onclick = submitCurrentSection;
            } else {
                // Last Question of Last Section
                nextBtn.innerText = "FINISH TEST";
                nextBtn.className = "nav-btn btn-submit-test";
                nextBtn.onclick = submitTest;
            }
        } else {
            // Normal Next
            nextBtn.innerText = "Next";
            nextBtn.className = "nav-btn btn-next";
            nextBtn.onclick = () => { loadQuestion(currentIdx + 1); };
        }
    }

    renderPalette();
    if(window.MathJax) MathJax.typesetPromise();
}

function submitCurrentSection() {
    if(!confirm(`Submit ${SECTIONS[activeSectionIndex]} Section?\nYou cannot go back to this section.`)) return;
    
    activeSectionIndex++; // Move to next section
    currentIdx = sectionStartIndices[activeSectionIndex]; // Jump to first Q of next section
    renderSectionTabs();
    loadQuestion(currentIdx);
}

function prev() {
    // DSSSB Rule: Can go back within section, but not to previous section
    const startOfSec = sectionStartIndices[activeSectionIndex];
    if(currentIdx > startOfSec) {
        loadQuestion(currentIdx - 1);
    } else {
        // alert("Cannot go to previous section (Locked).");
    }
}

function selectAnswer(i) { if(!submitted) { answers[currentIdx]=i; loadQuestion(currentIdx); } }
function clearResponse() { if(!submitted) { answers[currentIdx]=null; reviewStatus[currentIdx]=false; loadQuestion(currentIdx); } }
function markReview() { if(!submitted) { reviewStatus[currentIdx]=!reviewStatus[currentIdx]; loadQuestion(currentIdx); } }

/* --- TIMER & ANTI-CHEAT --- */
function startTimer() {
    timerInterval = setInterval(() => {
        if(timeLeft <= 0) { submitTest(); return; }
        timeLeft--;
        const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
        const s = (timeLeft % 60).toString().padStart(2,'0');
        const tObj = document.getElementById('timer');
        tObj.innerText = `${m}:${s}`;
        
        // Timer Warning Color
        if(timeLeft < 300) { tObj.style.background="#ffebee"; tObj.style.color="red"; }
    }, 1000);
}

function startAntiCheat() {
    document.addEventListener("visibilitychange", () => {
        if(document.hidden && !submitted) {
            warningCount++;
            if(warningCount >= 3) {
                alert("‚õî MAX WARNINGS REACHED!\nSystem is Auto-Submitting your test.");
                submitTest();
            } else {
                alert(`‚ö†Ô∏è WARNING ${warningCount}/3\nTab switching is Prohibited!\nNext violation may submit your test.`);
            }
        }
    });
    // Disable Right Click
    document.addEventListener('contextmenu', e => e.preventDefault());
}

/* --- SUBMIT & RESULTS --- */
function submitTest() {
    if(!submitted && !confirm("Are you sure you want to FINISH the test?")) return;
    submitted = true; clearInterval(timerInterval);
    
    // Logic to unlock all tabs for review
    const tabs = document.querySelectorAll('.sec-tab');
    tabs.forEach(t => { t.classList.remove('locked'); t.classList.add('active'); t.style.cursor="pointer"; });
    
    // Show Full Palette Button
    document.getElementById('mainSubmitBtn').style.display="none";

    // Calc Score
    let totalScore=0, totalC=0, totalW=0, totalS=0;
    QUESTIONS.forEach((q, i) => {
        if(answers[i]===null) totalS++;
        else if(answers[i]===q.a) { totalC++; totalScore+=1; }
        else { totalW++; totalScore-=NEGATIVE_MARK; }
    });

    // Score Card
    document.getElementById('modalTitle').innerText = "Score Card";
    let html = `<div style="text-align:center; padding:20px;">
        <h2>${document.getElementById('stuName').value}</h2>
        <div style="font-size:30px; font-weight:bold; color:var(--primary)">${totalScore.toFixed(2)} / ${QUESTIONS.length}</div>
        <p>Correct: <span style="color:green">${totalC}</span> | Wrong: <span style="color:red">${totalW}</span> | Skip: ${totalS}</p>
        <button onclick="downloadPDF()" class="tool-btn" style="background:var(--primary); color:#fff; padding:10px 20px; font-size:16px;">üì• Download PDF</button>
    </div>`;
    
    // Full Solution View
    html += `<hr><h3>Detailed Solutions</h3>`;
    QUESTIONS.forEach((q,i) => {
        let st = answers[i]===null?"Skipped":(answers[i]===q.a?"Correct":"Wrong");
        let col = answers[i]===null?"gray":(answers[i]===q.a?"green":"red");
        html += `<div class="result-q-box">
            <div style="display:flex; justify-content:space-between"><b>Q.${i+1}</b> <b style="color:${col}">${st}</b></div>
            <div>${(currentLang==="HI"?q.q_hi:q.q_en)||q.q_hi}</div>
            <div style="background:#f0f0f0; padding:5px; margin-top:5px; font-size:13px;"><b>Ans:</b> ${q.o_en[q.a]} <br> <b>Exp:</b> ${q.e_hi||"N/A"}</div>
        </div>`;
    });

    document.getElementById('qpContent').innerHTML = html;
    document.getElementById('qpModal').style.display = "flex";
    
    // Telegram
    fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            chat_id:TELEGRAM_CHAT_ID,
            text:`üîí *Secure Test Submitted*\nüë§ ${document.getElementById('stuName').value}\nüéØ Score: ${totalScore}\n‚úÖ ${totalC} ‚ùå ${totalW} ‚ûñ ${totalS}\n‚ö†Ô∏è Warnings: ${warningCount}/3`
        })
    });
}

/* UTILS */
function renderPalette() {
    const grid = document.getElementById('paletteGrid'); grid.innerHTML = "";
    QUESTIONS.forEach((q, k) => {
        // Only show palette buttons for Current or Previous Sections
        // If question belongs to a future section (locked), show locked state
        const qSecIdx = SECTIONS.indexOf(q.section);
        
        let cls = "qbtn";
        if (qSecIdx > activeSectionIndex && !submitted) {
            // Future locked question
            const btn = document.createElement('button');
            btn.className = "qbtn"; btn.style.background="#eee"; btn.style.color="#ccc"; btn.innerText = "üîí";
            btn.disabled = true;
            grid.appendChild(btn);
            return;
        }

        if(k === currentIdx) cls += " current";
        if(submitted) { if(answers[k]===q.a) cls+=" answered"; else if(answers[k]!==null) cls+=" wrong"; }
        else {
            if(reviewStatus[k]) cls += " review";
            else if(answers[k]!==null) cls += " answered"; 
        }
        
        const btn = document.createElement('button'); btn.className = cls; btn.innerText = k + 1;
        btn.onclick = () => { 
            // Can only jump if within active section OR if submitted
            if (submitted || qSecIdx === activeSectionIndex) {
                loadQuestion(k); if(window.innerWidth<768) togglePalette(); 
            } else {
                alert("Cannot modify previous section.");
            }
        };
        grid.appendChild(btn);
    });
}

function togglePalette() { document.getElementById('palettePanel').classList.toggle('show'); document.getElementById('bgOverlay').classList.toggle('show'); }
function closeTg(){ document.getElementById('tgPopup').style.display = "none"; }
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('dsssb_dark_mode', document.body.classList.contains('dark-mode')); }
function toggleLang() { currentLang = currentLang==="HI"?"EN":"HI"; loadQuestion(currentIdx); }
function changeFont(d) { fontSize+=d; document.getElementById('qContent').style.fontSize=fontSize+"px"; }
function openZoom(src) { document.getElementById('zoomImg').src=src; document.getElementById('zoomModal').style.display='flex'; }
function closeZoom() { document.getElementById('zoomModal').style.display='none'; }
function openQP() { 
    // Show only questions from active or previous sections
    let html = "";
    QUESTIONS.forEach((q,i) => {
        const qSecIdx = SECTIONS.indexOf(q.section);
        if(!submitted && qSecIdx > activeSectionIndex) return; // Hide future sections
        
        html += `<div style="border-bottom:1px solid #ddd; padding:10px;"><b>Q.${i+1}</b> ${q.q_hi}<br><small>${q.o_hi.join(', ')}</small></div>`;
    });
    document.getElementById('qpContent').innerHTML = html; 
    document.getElementById('qpModal').style.display='flex'; 
}
function closeQP() { document.getElementById('qpModal').style.display='none'; }
function downloadPDF() {
    const el = document.getElementById('qpContent');
    const opt = { margin:5, filename:'DSSSB_Result.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
    html2pdf().set(opt).from(el).save();
}
</script>
</body>
</html>
