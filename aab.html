<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DSSSB CBT Professional Portal</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* =========================
   CORE VARIABLES & THEME
   ========================= */
:root {
  --primary: #2196f3;
  --primary-dark: #1976d2;
  --success: #2e7d32;
  --danger: #c62828;
  --warning: #f9a825;
  --bg-body: #f5f7fa;
  --bg-card: #ffffff;
  --text-main: #333333;
  --text-muted: #555555;
  --border-color: #dddddd;
  --header-bg: #ffffff;
  --section-bar-bg: #e3f2fd;
  --opt-hover: #f0f7ff;
  --opt-sel-bg: #e3f2fd;
  --palette-bg: #ffffff;
  --zoom-bg: rgba(255, 255, 255, 0.95);
  --font-base: 16px;
}

body.dark-mode {
  --primary: #64b5f6;
  --primary-dark: #42a5f5;
  --success: #66bb6a;
  --danger: #ef5350;
  --bg-body: #121212;
  --bg-card: #1e1e1e;
  --text-main: #e0e0e0;
  --text-muted: #b0b0b0;
  --border-color: #333333;
  --header-bg: #1e1e1e;
  --section-bar-bg: #263238;
  --opt-hover: #2c3e50;
  --opt-sel-bg: #1565c0;
  --palette-bg: #1e1e1e;
  --zoom-bg: rgba(0, 0, 0, 0.9);
}

html, body {
  width: 100%; margin: 0; padding: 0;
  overflow-x: hidden; font-family: 'Segoe UI', Arial, sans-serif;
  background: var(--bg-body); color: var(--text-main);
  height: 100%; user-select: none; /* Anti-Copy */
}
body { display: grid; grid-template-rows: auto auto 1fr auto; height: 100vh; }

/* SCREENS */
.full-screen-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
.start-card { background: var(--bg-card); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); width: 100%; max-width: 500px; border: 1px solid var(--border-color); text-align: center; }
.inst-list { text-align: left; margin: 15px 0; font-size: 14px; line-height: 1.6; color: var(--text-main); }
.start-input { width: 90%; padding: 12px; margin: 10px 0; border: 2px solid var(--border-color); border-radius: 6px; font-size: 16px; background: var(--bg-body); color: var(--text-main); }
.primary-btn { background: var(--primary); color: #fff; border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer; transition: 0.2s; width: 100%; margin-top: 10px; }
.primary-btn:disabled { background: #999; cursor: not-allowed; }

/* HEADER */
header { background: var(--header-bg); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 20; border-bottom: 1px solid var(--border-color); }
.brand { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
.tools { display: flex; gap: 8px; }
.tool-btn { background: var(--bg-body); border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; color: var(--text-main); }

/* SECTION BAR */
#sectionBar { background: var(--section-bar-bg); display: flex; overflow-x: auto; white-space: nowrap; box-shadow: inset 0 -1px 2px rgba(0,0,0,0.1); scrollbar-width: none; }
.sec-tab { padding: 12px 16px; font-size: 14px; font-weight: 600; color: var(--text-muted); cursor: not-allowed; opacity: 0.6; border-bottom: 3px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
.sec-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(33, 150, 243, 0.1); opacity: 1; cursor: default; }
.sec-tab.done { color: var(--success); border-bottom-color: var(--success); opacity: 0.8; }

/* MAIN AREA */
#mainArea { padding: 10px; overflow-y: auto; position: relative; padding-bottom: 80px; display: none; }
.card { background: var(--bg-card); padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; font-size: var(--font-base); border: 1px solid var(--border-color); color: var(--text-main); }
.passage-box { background: var(--bg-body); border-left: 4px solid var(--primary); padding: 10px; margin-bottom: 15px; font-size: 0.95em; color: var(--text-main); max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); }

/* IMAGE STYLING */
img { max-width: 100%; height: auto; border-radius: 4px; }
.q-img { border: 1px solid var(--border-color); margin: 10px 0; cursor: zoom-in; display: block; }
.opt img { max-height: 80px; vertical-align: middle; } /* Option Images */

/* OPTIONS */
.opt { border: 1px solid var(--border-color); padding: 12px 15px; margin: 8px 0; border-radius: 6px; cursor: pointer; transition: background 0.15s; display: flex; align-items: center; color: var(--text-main); }
.opt:hover { background: var(--opt-hover); border-color: var(--primary); }
.opt.sel { background: var(--opt-sel-bg); border-color: var(--primary); font-weight: 600; }
.opt.correct { background: rgba(46, 125, 50, 0.2); border-color: var(--success); }
.opt.wrong { background: rgba(198, 40, 40, 0.2); border-color: var(--danger); }
.opt-circle { min-width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-muted); margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text-main); flex-shrink: 0; }
.opt.sel .opt-circle { border-color: var(--primary); background: var(--primary); color: #fff; }

/* FOOTER */
footer { background: var(--bg-card); padding: 10px; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; position: fixed; bottom: 0; width: 100%; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: none; }
.nav-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: #fff; cursor: pointer; font-size: 14px; }
.btn-prev { background: #757575; }
.btn-next { background: var(--primary); }
.btn-submit-sec { background: var(--success); grid-column: span 1; animation: pulse 2s infinite; }
.btn-submit-test { background: var(--danger); }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
.btn-palette { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); grid-column: span 3; }

/* PALETTE */
#palettePanel { position: fixed; top: 0; right: -100%; width: 85%; max-width: 320px; height: 100%; background: var(--palette-bg); z-index: 100; transition: right 0.3s; box-shadow: -5px 0 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; color: var(--text-main); }
#palettePanel.show { right: 0; }
.p-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
.p-grid { padding: 15px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; align-content: start; }
.qbtn { aspect-ratio: 1; border-radius: 50%; font-weight: bold; font-size: 12px; cursor: pointer; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); }
.qbtn.visited { background: var(--bg-body); border-color: #bbb; } 
.qbtn.answered { background: var(--success); color: #fff; border: none; }
.qbtn.review { background: var(--primary-dark); color: #fff; }
.qbtn.current { box-shadow: 0 0 0 2px var(--text-main); transform: scale(1.1); }

/* EXTRAS */
#timer { background: var(--bg-card); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: var(--danger); border: 1px solid var(--danger); }
#expBox { margin-top: 15px; padding: 15px; background: rgba(46, 125, 50, 0.1); border-left: 4px solid var(--success); border-radius: 4px; font-size: 14px; display: none; color: var(--text-main); }
#expBox iframe, #expBox video { max-width: 100%; border-radius: 4px; border: 1px solid #ccc; margin-top: 10px; }
#expBox table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
#expBox th, #expBox td { border: 1px solid var(--border-color); padding: 5px; text-align: left; }
.solution-container { line-height: 1.5; }

.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
.overlay.show { display: block; }
#tgPopup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: var(--bg-card); padding:25px; width:85%; max-width:320px; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.4); z-index:9999; text-align:center; display:none; border: 1px solid var(--border-color); color:var(--text-main); }
#tgPopup a{ display:block; background:#0088cc; color:#fff; padding:12px; border-radius:8px; text-decoration:none; margin-top:15px; font-weight:bold; }
#qpModal { position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: var(--bg-card); color: var(--text-main); z-index: 200; border-radius: 8px; display: none; flex-direction: column; border: 1px solid var(--border-color); }
#zoomModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--zoom-bg); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column; }
#zoomImg { max-width: 90%; max-height: 85vh; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: 1px solid #fff; }

.result-q-box { margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); page-break-inside: avoid; }
.res-opt { padding: 5px; margin: 2px 0; border-radius: 4px; font-size: 14px; }
.res-opt.c { background: rgba(46, 125, 50, 0.2); border: 1px solid var(--success); }
.res-opt.w { background: rgba(198, 40, 40, 0.2); border: 1px solid var(--danger); text-decoration: line-through; }

@media(min-width: 768px) {
  body { grid-template-columns: 1fr 300px; grid-template-rows: auto auto 1fr; }
  header { grid-column: 1 / -1; }
  #sectionBar { grid-column: 1 / 2; }
  #mainArea { grid-column: 1 / 2; grid-row: 3 / 4; padding-bottom: 20px; }
  #palettePanel { position: static; width: auto; height: auto; right: auto; grid-column: 2 / 3; grid-row: 2 / 4; border-left: 1px solid var(--border-color); box-shadow: none; z-index: 1; }
  footer { grid-column: 1 / 2; position: static; display: flex; justify-content: space-between; box-shadow: none; border-top: 1px solid var(--border-color); }
  .btn-palette { display: none; } 
  .p-grid { grid-template-columns: repeat(4, 1fr); }
  #qpModal { width: 60%; left: 20%; }
}
</style>
</head>

<body onload="initApp()">

<div id="zoomModal" onclick="closeZoom()"><span style="position:absolute; top:20px; right:20px; font-size:40px; color:var(--text-main); cursor:pointer;">&times;</span><img id="zoomImg" src=""><div style="color:var(--text-main); margin-top:10px;">Click anywhere to close</div></div>
<div class="overlay" onclick="togglePalette()" id="bgOverlay"></div>

<div id="startScreen" class="full-screen-overlay">
    <div class="start-card">
        <h2 style="color:var(--primary); margin-top:0;">DSSSB Professional Portal</h2>
        <p style="color:var(--text-muted); margin-bottom:5px;">Enter Details to Login</p>
        <input type="text" id="startNameInput" class="start-input" placeholder="Full Name">
        <input type="password" id="examPassInput" class="start-input" placeholder="Enter Password" autocomplete="off">
        <button class="primary-btn" onclick="goToInstructions()">LOGIN</button>
    </div>
</div>

<div id="instScreen" class="full-screen-overlay" style="display:none;">
    <div class="start-card" style="max-width:600px; text-align:left;">
        <h3 style="color:var(--primary); border-bottom:1px solid var(--border-color); padding-bottom:10px;">Exam Rules (Strict)</h3>
        <div class="inst-list">
            <b>1. Duration:</b> <span style="color:var(--danger)">120 Minutes (Reverse Countdown)</span><br>
            <b>2. Sectional Logic:</b> Sections are locked. You must <u>Submit the current section</u> to proceed. Going back is disabled.<br>
            <b>3. Anti-Cheating:</b> Tab switching is prohibited. 3 warnings = Auto Submit.<br>
            <b>4. Language:</b> Use toggle button for English/Hindi explanations.
        </div>
        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600; font-size:14px; margin-top:20px;">
            <input type="checkbox" id="instCheck" onchange="toggleStartBtn()" style="width:20px; height:20px; margin-right:10px;">
            I have read and understood the instructions.
        </label>
        <br>
        <button id="finalStartBtn" class="primary-btn" onclick="startTestFlow()" disabled>START TEST</button>
    </div>
</div>

<div id="tgPopup">
 <b>üì¢ Join DSSSB Smart Notes</b><br><br>Daily Tests ‚Ä¢ PDFs ‚Ä¢ Results<br>
 <a href="https://t.me/DSSSBSmartNotes" target="_blank">Join Telegram</a><br><br>
 <button class="tg-btn-continue" onclick="closeTg()">Continue Test</button>
</div>

<header>
  <div class="brand">DSSSB CBT <span style="font-size:0.8em; color:var(--text-muted)">v4.0 Secure</span></div>
  <div style="display:flex; align-items:center; gap:10px;">
    <div id="timer">120:00</div>
    <button class="tool-btn" onclick="toggleDarkMode()" id="themeBtn">üåô</button>
    <button class="tool-btn" onclick="toggleLang()" id="langBtn">EN/HI</button>
    <button class="tool-btn" onclick="toggleFS()">‚õ∂</button>
    <button class="tool-btn" onclick="openQP()">üìÑ Paper</button>
  </div>
</header>

<div id="sectionBar"></div>

<div id="mainArea">
  <input type="hidden" id="stuName">
  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:var(--text-muted); font-size:13px;">
      <span>Q. <b id="qNumDisp">1</b></span>
      <span style="display:flex; gap:10px;"><span style="color:var(--success)">+1.0</span><span style="color:var(--danger)">-0.25</span></span>
    </div>
    <div style="font-size:14px; text-align:right; margin-bottom:5px;">
        <button class="tool-btn" onclick="changeFont(1)">A+</button> <button class="tool-btn" onclick="changeFont(-1)">A-</button>
    </div>
    <div id="qContent"></div> 
    <div id="opts"></div>        
    <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
        <button class="tool-btn" style="color:orange; border:1px solid orange; background:var(--bg-card)" onclick="markReview()">‚≠ê Review</button>
        <button class="tool-btn" onclick="clearResponse()">Clear</button>
    </div>
    <div id="expBox"></div>
  </div>
</div>

<div id="palettePanel">
  <div class="p-header"><b>Palette</b> <button onclick="togglePalette()" class="close-pal" style="border:none;background:none;font-size:20px;">&times;</button></div>
  <div style="padding:10px; font-size:12px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
    <div><span style="color:var(--success)">‚ñ†</span> Ans</div> <div><span style="color:var(--text-muted)">‚ñ†</span> Skip</div>
    <div><span style="color:var(--primary)">‚ñ†</span> Review</div> <div><span style="color:#999">‚ñ†</span> Locked</div>
  </div>
  <div class="p-grid" id="paletteGrid"></div>
  <div class="p-footer"><button id="mainSubmitBtn" onclick="submitTest()" class="btn-submit-test" style="width:100%; padding:12px; color:#fff; border:none; border-radius:4px; font-weight:bold; display:none;">FINISH EXAM</button></div>
</div>

<footer>
  <button class="nav-btn btn-palette" onclick="togglePalette()">Grid</button>
  <button class="nav-btn btn-prev" onclick="prev()">Previous</button>
  <button class="nav-btn btn-next" id="nextBtn" onclick="next()">Next</button>
</footer>

<div id="qpModal">
    <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"><b id="modalTitle">Question Paper</b><button onclick="closeQP()" style="border:none; background:none; font-size:20px;">&times;</button></div>
    <div id="qpContent" style="padding:20px; overflow-y:auto; flex:1;"></div>
</div>

<script>
/* =========================================
   1. CONFIGURATION & SECURITY
   ========================================= */
const PASS_ENCODED = "ZHNzc2IyNDA2"; 
const TOTAL_TIME_MINS = 120;
const TELEGRAM_BOT_TOKEN="8486464606:AAFT_Bd0P2HYqKNPjCm3s7TGgfM4HWmOYvs";
const TELEGRAM_CHAT_ID="@dsssbcbtresult";

// ----------------------------------------------------
// UPDATED SECTIONS ARRAY (2 Parts per Subject)
// ----------------------------------------------------
const SECTIONS = [
    "Reasoning 1", "Reasoning 2",
    "GK 1", "GK 2",
    "Maths 1", "Maths 2",
    "English 1", "English 2",
    "Hindi 1", "Hindi 2"
];

const NEGATIVE_MARK = 0.25;

/* =========================================
   2. QUESTIONS DATA (UPDATED SECTIONS)
   ========================================= */
const QUESTIONS = [
  // --- Reasoning Part 1 ---
  { 
    section: "Reasoning 1", 
    q_hi: "‡§®‡•Ä‡§ö‡•á ‡§¶‡•Ä ‡§ó‡§à ‡§Ü‡§ï‡•É‡§§‡§ø ‡§ï‡§æ ‡§¶‡§∞‡•ç‡§™‡§£ ‡§™‡•ç‡§∞‡§§‡§ø‡§¨‡§ø‡§Æ‡•ç‡§¨ ‡§ö‡•Å‡§®‡•á‡§Ç:<br><img src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Small_triangle.svg/100px-Small_triangle.svg.png' alt='Question Image'>", 
    q_en: "Choose the mirror image of the figure below:<br><img src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Small_triangle.svg/100px-Small_triangle.svg.png' alt='Question Image'>", 
    op_hi: [
        "<img src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Small_triangle.svg/50px-Small_triangle.svg.png'>", 
        "<img src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Small_triangle.svg/50px-Small_triangle.svg.png' style='transform:scaleX(-1)'>", 
        "C", "D"
    ], 
    op_en: [
        "<img src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Small_triangle.svg/50px-Small_triangle.svg.png'>", 
        "<img src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Small_triangle.svg/50px-Small_triangle.svg.png' style='transform:scaleX(-1)'>", 
        "C", "D"
    ], 
    ans: "2", 
    solution: "<div class='solution-container'>‡§¶‡§∞‡•ç‡§™‡§£ ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§Ø‡§æ‡§Å ‡§≠‡§æ‡§ó ‡§¶‡§æ‡§Ø‡§æ‡§Å ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§</div>"
  },
  { 
      section: "Reasoning 1", 
      q_hi: "‡§µ‡§ø‡§∑‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç:", q_en: "Find odd one:", 
      op_hi: ["‡§∏‡•á‡§¨", "‡§ó‡•á‡§Ç‡§¶", "‡§ï‡§Æ‡§≤", "‡§ó‡•Å‡§≤‡§æ‡§¨"], op_en: ["Apple", "Ball", "Lotus", "Rose"], 
      ans: "2", 
      solution: "<div class='solution-container'>‡§ó‡•á‡§Ç‡§¶ ‡§ï‡•É‡§§‡•ç‡§∞‡§ø‡§Æ ‡§π‡•à‡•§</div>" 
  },
  
  // --- Reasoning Part 2 (Demo) ---
  { 
      section: "Reasoning 2", 
      q_hi: "(Reasoning Part 2 Demo) ‡§Ü‡§ï‡•É‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§§‡§®‡•á ‡§§‡•ç‡§∞‡§ø‡§≠‡•Å‡§ú ‡§π‡•à‡§Ç?", q_en: "(Reasoning Part 2 Demo) Triangles count?", 
      op_hi: ["10", "12", "14", "16"], op_en: ["10", "12", "14", "16"], 
      ans: "2", 
      solution: "<div class='solution-container'>12 ‡§§‡•ç‡§∞‡§ø‡§≠‡•Å‡§ú</div>" 
  },

  // --- GK Part 1 ---
  { 
      section: "GK 1", 
      q_hi: "‡§Æ‡•å‡§≤‡§ø‡§ï ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø ‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§≤‡§ø‡§è ‡§ó‡§è?", q_en: "Fundamental Duties source?", 
      op_hi: ["USA", "Russia", "UK", "Canada"], op_en: ["USA", "Russia", "UK", "Canada"], 
      ans: "2", 
      solution: "<div class='solution-container'>‡§∞‡•Ç‡§∏ (USSR)</div>" 
  },
  // --- GK Part 2 (Placeholder) ---
  { section: "GK 2", q_hi: "GK Part 2 Placeholder Question", q_en: "GK Part 2 Placeholder", op_hi: ["A","B","C","D"], op_en: ["A","B","C","D"], ans: "1", solution: "Solution" },

  // --- Maths Part 1 ---
  { 
      section: "Maths 1", 
      q_hi: "CP=800, Profit=25%, SP=?", q_en: "CP=800, Profit=25%, SP=?", 
      op_hi: ["1000", "900", "1100", "1200"], op_en: ["1000", "900", "1100", "1200"], 
      ans: "1", 
      solution: "<div class='solution-container'>SP = 1000</div>" 
  },
  // --- Maths Part 2 (Placeholder) ---
  { section: "Maths 2", q_hi: "Maths Part 2 Placeholder Question", q_en: "Maths Part 2 Placeholder", op_hi: ["A","B","C","D"], op_en: ["A","B","C","D"], ans: "1", solution: "Solution" },

  // --- English Part 1 ---
  { 
      section: "English 1", 
      q_en: "Synonym of Happy?", q_hi: "Happy ‡§ï‡§æ ‡§™‡§∞‡•ç‡§Ø‡§æ‡§Ø‡§µ‡§æ‡§ö‡•Ä?", 
      op_en: ["Sad", "Joyful", "Angry", "Cry"], op_hi: ["Sad", "Joyful", "Angry", "Cry"], 
      ans: "2", 
      solution: "<div class='solution-container'>Happy = Joyful</div>" 
  },
  // --- English Part 2 (Placeholder) ---
  { section: "English 2", q_hi: "English Part 2 Placeholder Question", q_en: "English Part 2 Placeholder", op_hi: ["A","B","C","D"], op_en: ["A","B","C","D"], ans: "1", solution: "Solution" },

  // --- Hindi Part 1 ---
  { 
      section: "Hindi 1", 
      q_hi: "‡§∏‡§Ç‡§ß‡§ø ‡§µ‡§ø‡§ö‡•ç‡§õ‡•á‡§¶: ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§≤‡§Ø", q_en: "", 
      op_hi: ["‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ + ‡§Ü‡§≤‡§Ø", "‡§µ‡§ø‡§¶‡•ç‡§Ø + ‡§≤‡§Ø", "‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ + ‡§≤‡§Ø", "‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•ã‡§à ‡§®‡§π‡•Ä‡§Ç"], op_en: ["Vidya + Aalay", "Option B", "Option C", "Option D"],
      ans: "1", 
      solution: "<div class='solution-container'>‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ + ‡§Ü‡§≤‡§Ø</div>" 
  },
  // --- Hindi Part 2 (Placeholder) ---
  { section: "Hindi 2", q_hi: "Hindi Part 2 Placeholder Question", q_en: "Hindi Part 2 Placeholder", op_hi: ["A","B","C","D"], op_en: ["A","B","C","D"], ans: "1", solution: "Solution" }
];

/* STATE */
let currentIdx = 0;
let currentLang = "HI";
let answers = new Array(QUESTIONS.length).fill(null);
let reviewStatus = new Array(QUESTIONS.length).fill(false);
let submitted = false;
let timeLeft = TOTAL_TIME_MINS * 60; 
let fontSize = 16;
let timerInterval;
let warningCount = 0;
let isDarkMode = false;
let activeSectionIndex = 0;
let sectionStartIndices = [];
let sectionEndIndices = [];

/* --- INIT --- */
function initApp() {
    if(localStorage.getItem('dsssb_dark_mode') === 'true') toggleDarkMode();
    calcSectionIndices();
    document.getElementById('startScreen').style.display = 'flex';
}

function calcSectionIndices() {
    SECTIONS.forEach(sec => {
        const start = QUESTIONS.findIndex(q => q.section === sec);
        let end = start;
        for(let i=start; i<QUESTIONS.length; i++){
            if(QUESTIONS[i].section === sec) end = i;
            else if(end > start) break;
        }
        // Safety check if section is empty/missing
        if(start !== -1) {
            sectionStartIndices.push(start);
            sectionEndIndices.push(end);
        } else {
            console.error("Missing questions for section: " + sec);
            sectionStartIndices.push(0); sectionEndIndices.push(0); // Fallback
        }
    });
}

function goToInstructions() {
    const name = document.getElementById('startNameInput').value.trim();
    const pass = document.getElementById('examPassInput').value.trim();
    if(!name) { alert("Enter Name"); return; }
    
    // SECURE PASSWORD CHECK (ENCODED MATCH)
    if(btoa(pass) !== PASS_ENCODED) { alert("‚ùå WRONG PASSWORD"); return; }
    
    document.getElementById('stuName').value = name;
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('instScreen').style.display = 'flex';
}

function toggleStartBtn() { document.getElementById('finalStartBtn').disabled = !document.getElementById('instCheck').checked; }

function startTestFlow() { 
    document.getElementById('instScreen').style.display = 'none'; 
    document.getElementById('mainArea').style.display = 'block';
    document.querySelector('footer').style.display = 'flex';
    document.getElementById('tgPopup').style.display = "block";
    currentIdx = sectionStartIndices[0];
    
    // TRIGGER FULL SCREEN
    toggleFS();
    
    renderSectionTabs(); loadQuestion(currentIdx); startTimer(); startAntiCheat();
    document.addEventListener('keydown', (e) => { 
        if(e.key === "ArrowRight") next(); 
        if(e.key === "ArrowLeft") prev(); 
    });
}

/* --- LOGIC (UPDATED FOR NEW JSON FORMAT) --- */
function renderSectionTabs() {
    const bar = document.getElementById('sectionBar');
    let html = "";
    SECTIONS.forEach((sec, i) => {
        let cls = "sec-tab";
        let icon = "üîí";
        if (i === activeSectionIndex) { cls += " active"; icon = "üü¢"; } 
        else if (i < activeSectionIndex) { cls += " done"; icon = "‚úÖ"; } 
        html += `<div class="${cls}">${icon} ${sec}</div>`;
    });
    bar.innerHTML = html;
}

function loadQuestion(idx) {
    currentIdx = idx;
    const q = QUESTIONS[idx];
    document.getElementById('qNumDisp').innerText = idx + 1;
    
    // Render Question
    const contentDiv = document.getElementById('qContent');
    const txt = (currentLang==="HI" && q.q_hi) ? q.q_hi : (q.q_en||q.q_hi);
    contentDiv.innerHTML = txt;
    contentDiv.style.fontSize = fontSize + "px";
    contentDiv.querySelectorAll('img').forEach(img => { img.classList.add('q-img'); img.onclick=()=>openZoom(img.src); });

    // Render Options
    const optsArr = (currentLang==="HI" && q.op_hi) ? q.op_hi : (q.op_en||q.op_hi);
    let html = "";
    
    // Convert ans string "1" to index 0
    const correctIdx = parseInt(q.ans) - 1;

    optsArr.forEach((opt, i) => {
        let cls = "opt";
        if(submitted) { if(i===correctIdx) cls+=" correct"; else if(answers[idx]===i) cls+=" wrong"; }
        else if(answers[idx]===i) cls+=" sel";
        html += `<div class="${cls}" onclick="selectAnswer(${i})"><div class="opt-circle">${String.fromCharCode(65+i)}</div><div>${opt}</div></div>`;
    });
    document.getElementById('opts').innerHTML = html;

    // Solution Logic
    if(submitted) {
       document.getElementById('expBox').innerHTML = "<b>Explanation:</b><br>" + q.solution;
       document.getElementById('expBox').style.display="block";
    }

    // Button Logic
    const nextBtn = document.getElementById('nextBtn');
    const isLastInSec = (currentIdx === sectionEndIndices[activeSectionIndex]);
    
    if(submitted) {
        nextBtn.innerText = "Next"; nextBtn.className = "nav-btn btn-next";
        nextBtn.onclick = () => { if(currentIdx < QUESTIONS.length-1) loadQuestion(currentIdx+1); };
    } else {
        if (isLastInSec) {
            if (activeSectionIndex < SECTIONS.length - 1) {
                nextBtn.innerText = `Submit ${SECTIONS[activeSectionIndex]}`;
                nextBtn.className = "nav-btn btn-submit-sec";
                nextBtn.onclick = submitCurrentSection;
            } else {
                nextBtn.innerText = "FINISH EXAM";
                nextBtn.className = "nav-btn btn-submit-test";
                nextBtn.onclick = submitTest;
            }
        } else {
            nextBtn.innerText = "Next"; nextBtn.className = "nav-btn btn-next";
            nextBtn.onclick = () => { loadQuestion(currentIdx + 1); };
        }
    }
    renderPalette();
    if(window.MathJax) MathJax.typesetPromise();
}

function submitCurrentSection() {
    if(!confirm(`Submit ${SECTIONS[activeSectionIndex]} Section?\nYou cannot go back to this section.`)) return;
    activeSectionIndex++; currentIdx = sectionStartIndices[activeSectionIndex]; renderSectionTabs(); loadQuestion(currentIdx);
}

function prev() {
    const startOfSec = sectionStartIndices[activeSectionIndex];
    if(currentIdx > startOfSec) loadQuestion(currentIdx - 1);
}
function next() { document.getElementById('nextBtn').click(); }
function selectAnswer(i) { if(!submitted) { answers[currentIdx]=i; loadQuestion(currentIdx); } }
function clearResponse() { if(!submitted) { answers[currentIdx]=null; reviewStatus[currentIdx]=false; loadQuestion(currentIdx); } }
function markReview() { if(!submitted) { reviewStatus[currentIdx]=!reviewStatus[currentIdx]; loadQuestion(currentIdx); } }
function toggleLang() { currentLang = currentLang==="HI"?"EN":"HI"; document.getElementById('langBtn').innerText = currentLang; loadQuestion(currentIdx); }

function startTimer() {
    timerInterval = setInterval(() => {
        if(timeLeft <= 0) { submitTest(); return; }
        timeLeft--;
        const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
        const s = (timeLeft % 60).toString().padStart(2,'0');
        const tObj = document.getElementById('timer');
        tObj.innerText = `${m}:${s}`;
        if(timeLeft < 300) { tObj.style.background="#ffebee"; tObj.style.color="red"; }
    }, 1000);
}

function startAntiCheat() {
    document.addEventListener("visibilitychange", () => {
        if(document.hidden && !submitted) {
            warningCount++;
            if(warningCount >= 3) { alert("‚õî MAX WARNINGS REACHED!\nAuto-Submitting."); submitTest(); }
            else { alert(`‚ö†Ô∏è WARNING ${warningCount}/3\nTab switching prohibited!`); }
        }
    });
    // DISABLE INSPECT ELEMENT
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
    }
}

function submitTest() {
    if(!submitted && !confirm("FINISH test?")) return;
    submitted = true; clearInterval(timerInterval);
    const tabs = document.querySelectorAll('.sec-tab'); tabs.forEach(t => { t.classList.remove('locked'); t.classList.add('active'); t.style.cursor="pointer"; });
    document.getElementById('mainSubmitBtn').style.display="none";

    let totalScore=0, totalC=0, totalW=0, totalS=0;
    let scoreData = {}; SECTIONS.forEach(s => scoreData[s] = {c:0, w:0, s:0});

    QUESTIONS.forEach((q, i) => {
        let s = q.section;
        const correctIdx = parseInt(q.ans) - 1; // Convert '1' to 0

        if(answers[i]===null) { totalS++; scoreData[s].s++; }
        else if(answers[i]===correctIdx) { totalC++; totalScore+=1; scoreData[s].c++; }
        else { totalW++; totalScore-=NEGATIVE_MARK; scoreData[s].w++; }
    });

    document.getElementById('modalTitle').innerText = "Score Card";
    let html = `<div style="text-align:center; padding:20px;"><h2>${document.getElementById('stuName').value}</h2><div style="font-size:30px; font-weight:bold; color:var(--primary)">${totalScore.toFixed(2)} / ${QUESTIONS.length}</div><p>Correct: <span style="color:green">${totalC}</span> | Wrong: <span style="color:red">${totalW}</span> | Skip: ${totalS}</p><div class="chart-container"><canvas id="resultChart"></canvas></div></div><table border="1" style="width:100%; border-collapse:collapse; text-align:center; margin-bottom:10px;"><tr><th>Sec</th><th>‚úÖ</th><th>‚ùå</th><th>‚ö™</th></tr>`;
    SECTIONS.forEach(s => { html += `<tr><td>${s}</td><td>${scoreData[s].c}</td><td>${scoreData[s].w}</td><td>${scoreData[s].s}</td></tr>`; });
    html += `</table>`;
    
    html += `<hr><h3>Detailed Solutions</h3>`;
    QUESTIONS.forEach((q,i) => {
        const correctIdx = parseInt(q.ans) - 1;
        let st = answers[i]===null?"Skipped":(answers[i]===correctIdx?"Correct":"Wrong");
        let col = answers[i]===null?"gray":(answers[i]===correctIdx?"green":"red");
        let qTxt = (currentLang==="EN" && q.q_en)?q.q_en:(q.q_hi);
        
        html += `<div class="result-q-box"><div style="display:flex; justify-content:space-between"><b>Q.${i+1}</b> <b style="color:${col}">${st}</b></div><div>${qTxt}</div><div style="background:#f0f0f0; padding:5px; margin-top:5px; font-size:13px;"><b>Your:</b> ${answers[i]!==null ? String.fromCharCode(65+answers[i]) : '-'} | <b>Ans:</b> ${String.fromCharCode(65+correctIdx)}<br><br><b>Exp:</b> ${q.solution}</div></div>`;
    });
    
    html += `<div style="text-align:center; margin-top:20px;"><button onclick="downloadPDF()" class="tool-btn" style="background:var(--primary); color:#fff; padding:10px;">Download PDF</button></div>`;
    document.getElementById('qpContent').innerHTML = html;
    document.getElementById('qpModal').style.display = "flex";
    
    const ctx = document.getElementById('resultChart').getContext('2d');
    new Chart(ctx, { type:'doughnut', data:{labels:['Correct','Wrong','Skip'], datasets:[{data:[totalC,totalW,totalS], backgroundColor:['#2e7d32','#c62828','#bdbdbd']}]} });
    
    fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ chat_id:TELEGRAM_CHAT_ID, text:`üîí *Result*\nüë§ ${document.getElementById('stuName').value}\nüéØ Score: ${totalScore}\n‚úÖ ${totalC} ‚ùå ${totalW}\n‚ö†Ô∏è Warnings: ${warningCount}` }) });
}

function renderPalette() {
    const grid = document.getElementById('paletteGrid'); grid.innerHTML = "";
    QUESTIONS.forEach((q, k) => {
        const correctIdx = parseInt(q.ans) - 1;
        const qSecIdx = SECTIONS.indexOf(q.section);
        if(!submitted && qSecIdx > activeSectionIndex) {
            const btn = document.createElement('button'); btn.className = "qbtn"; btn.innerText = "üîí"; btn.style.background="#eee"; btn.disabled=true; grid.appendChild(btn); return;
        }
        let cls = "qbtn"; if(k === currentIdx) cls += " current";
        if(submitted) { if(answers[k]===correctIdx) cls+=" answered"; else if(answers[k]!==null) cls+=" wrong"; }
        else { if(reviewStatus[k]) cls += " review"; else if(answers[k]!==null) cls += " answered"; }
        const btn = document.createElement('button'); btn.className = cls; btn.innerText = k + 1;
        btn.onclick = () => { if(submitted || qSecIdx === activeSectionIndex) { loadQuestion(k); if(window.innerWidth<768) togglePalette(); } };
        grid.appendChild(btn);
    });
}

function togglePalette() { document.getElementById('palettePanel').classList.toggle('show'); document.getElementById('bgOverlay').classList.toggle('show'); }
function closeTg(){ document.getElementById('tgPopup').style.display = "none"; }
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('dsssb_dark_mode', document.body.classList.contains('dark-mode')); }
function changeFont(d) { fontSize+=d; document.getElementById('qContent').style.fontSize=fontSize+"px"; }
function openZoom(src) { document.getElementById('zoomImg').src=src; document.getElementById('zoomModal').style.display='flex'; }
function closeZoom() { document.getElementById('zoomModal').style.display='none'; }
function openQP() { document.getElementById('qpModal').style.display='flex'; } 
function closeQP() { document.getElementById('qpModal').style.display='none'; }
function toggleFS() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
function downloadPDF() {
    const el = document.getElementById('qpContent');
    const btns = el.querySelectorAll('button'); btns.forEach(b=>b.style.display='none');
    const opt = { margin:5, filename:'Result.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
    html2pdf().set(opt).from(el).save().then(()=>{ btns.forEach(b=>b.style.display='inline-block'); });
}
</script>
</body>
</html>
