<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DSSSB Sectional Mock Test - English</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* =========================
   CORE VARIABLES & THEME
   ========================= */
:root {
  --primary: #2196f3;
  --primary-dark: #1976d2;
  --success: #2e7d32;
  --danger: #c62828;
  --warning: #f9a825;
  
  --bg-body: #f5f7fa;
  --bg-card: #ffffff;
  --text-main: #333333;
  --text-muted: #555555;
  --border-color: #dddddd;
  --header-bg: #ffffff;
  --section-bar-bg: #e3f2fd;
  --opt-hover: #f0f7ff;
  --opt-sel-bg: #e3f2fd;
  --palette-bg: #ffffff;
  --zoom-bg: rgba(255, 255, 255, 0.95);
  
  --font-base: 16px;
}

/* Dark Mode Overrides */
body.dark-mode {
  --primary: #64b5f6;
  --primary-dark: #42a5f5;
  --success: #66bb6a;
  --danger: #ef5350;
  
  --bg-body: #121212;
  --bg-card: #1e1e1e;
  --text-main: #e0e0e0;
  --text-muted: #b0b0b0;
  --border-color: #333333;
  --header-bg: #1e1e1e;
  --section-bar-bg: #263238;
  --opt-hover: #2c3e50;
  --opt-sel-bg: #1565c0;
  --palette-bg: #1e1e1e;
  --zoom-bg: rgba(0, 0, 0, 0.9);
}

html, body {
  width: 100%; margin: 0; padding: 0;
  overflow-x: hidden; font-family: 'Segoe UI', Arial, sans-serif;
  background: var(--bg-body); color: var(--text-main);
  height: 100%;
  transition: background 0.3s, color 0.3s;
}

/* =========================
   LAYOUT GRID
   ========================= */
body {
  display: grid;
  grid-template-rows: auto auto 1fr auto; 
  height: 100vh;
}

/* =========================
   SCREENS
   ========================= */
.full-screen-overlay {
  position: fixed; inset: 0;
  background: var(--bg-body);
  z-index: 2000;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  padding: 20px;
}
.start-card {
  background: var(--bg-card);
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  width: 100%; max-width: 500px;
  border: 1px solid var(--border-color);
  text-align: center;
}

.inst-list { text-align: left; margin: 15px 0; font-size: 14px; line-height: 1.6; color: var(--text-main); }
.inst-list li { margin-bottom: 8px; }

.start-input {
  width: 90%; padding: 12px; margin: 20px 0;
  border: 2px solid var(--border-color); border-radius: 6px;
  font-size: 16px; background: var(--bg-body); color: var(--text-main);
}
.primary-btn {
  background: var(--primary); color: #fff;
  border: none; padding: 12px 30px;
  font-size: 16px; font-weight: bold;
  border-radius: 6px; cursor: pointer;
  transition: 0.2s; width: 100%; margin-top: 10px;
}
.primary-btn:disabled { background: #999; cursor: not-allowed; }
.secondary-btn {
    background: transparent; color: var(--text-muted); border: 2px solid var(--border-color);
    margin-top: 10px; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold;
}

/* =========================
   HEADER & NAV
   ========================= */
header {
  background: var(--header-bg); padding: 10px 15px;
  display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 20;
  border-bottom: 1px solid var(--border-color);
}
.brand { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
.tools { display: flex; gap: 8px; }
.tool-btn {
  background: var(--bg-body); border: 1px solid var(--border-color); 
  padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;
  font-weight: 600; color: var(--text-main);
}

/* SUB-HEADER (Subject Name) */
#subHeader {
    background: var(--section-bar-bg); padding: 10px 15px;
    font-weight: bold; color: var(--primary-dark);
    border-bottom: 1px solid var(--border-color);
    text-align: center; font-size: 1.1em;
}

/* =========================
   MAIN CONTENT
   ========================= */
#mainArea {
  padding: 10px; overflow-y: auto; position: relative;
  padding-bottom: 80px; display: none;
}
.card {
  background: var(--bg-card); padding: 16px; border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
  font-size: var(--font-base); border: 1px solid var(--border-color);
  color: var(--text-main);
}
.passage-box {
  background: var(--bg-body); border-left: 4px solid var(--primary);
  padding: 10px; margin-bottom: 15px; font-size: 0.95em;
  color: var(--text-main); max-height: 200px; overflow-y: auto;
  border: 1px solid var(--border-color);
}

/* IMAGE STYLING */
.q-img {
    max-width: 100%; height: auto; border: 1px solid var(--border-color); 
    border-radius: 4px; margin: 10px 0; cursor: zoom-in; transition: transform 0.2s; display: block;
}
.q-img:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

.opt {
  border: 1px solid var(--border-color); padding: 12px 15px;
  margin: 8px 0; border-radius: 6px; cursor: pointer;
  transition: background 0.15s; display: flex; align-items: center;
  color: var(--text-main);
}
.opt:hover { background: var(--opt-hover); border-color: var(--primary); }
.opt.sel { background: var(--opt-sel-bg); border-color: var(--primary); font-weight: 600; }
.opt.correct { background: rgba(46, 125, 50, 0.2); border-color: var(--success); }
.opt.wrong { background: rgba(198, 40, 40, 0.2); border-color: var(--danger); }
.opt-circle {
  width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted);
  margin-right: 12px; display: flex; align-items: center; justify-content: center;
  font-size: 10px; color: var(--text-main);
}
.opt.sel .opt-circle { border-color: var(--primary); background: var(--primary); color: #fff; }

footer {
  background: var(--bg-card); padding: 10px; border-top: 1px solid var(--border-color);
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
  position: fixed; bottom: 0; width: 100%;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: none;
}
.nav-btn {
  padding: 12px; border: none; border-radius: 6px;
  font-weight: bold; color: #fff; cursor: pointer; font-size: 14px;
}
.btn-prev { background: #757575; }
.btn-next { background: var(--primary); }
.btn-submit { background: var(--success); }
.btn-palette { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); grid-column: span 3; }

#palettePanel {
  position: fixed; top: 0; right: -100%; width: 85%; max-width: 320px;
  height: 100%; background: var(--palette-bg); z-index: 100;
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: -5px 0 25px rgba(0,0,0,0.2);
  display: flex; flex-direction: column; color: var(--text-main);
}
#palettePanel.show { right: 0; }
.p-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
.p-grid { padding: 15px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; align-content: start; }
.p-footer { padding: 15px; border-top: 1px solid var(--border-color); }

.qbtn {
  aspect-ratio: 1; border-radius: 50%; border: none; font-weight: bold; font-size: 12px;
  cursor: pointer; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
}
.qbtn.visited { background: var(--bg-body); border-color: #bbb; } 
.qbtn.answered { background: var(--success); color: #fff; border: none; }
.qbtn.review { background: var(--primary-dark); color: #fff; border-radius: 50%; }
.qbtn.review-ans { background: var(--primary-dark); color: #fff; position: relative; } 
.qbtn.review-ans::after { content:'‚úî'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fff; color:green; border-radius:50%; padding:1px;} 
.qbtn.current { box-shadow: 0 0 0 2px var(--text-main); transform: scale(1.1); }

#timer { background: var(--bg-card); padding: 5px 10px; border-radius: 4px; font-weight: bold; color: var(--primary); border: 1px solid var(--primary); }
#expBox { margin-top: 15px; padding: 15px; background: rgba(46, 125, 50, 0.1); border-left: 4px solid var(--success); border-radius: 4px; font-size: 14px; display: none; color: var(--text-main); }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
.overlay.show { display: block; }

#qpModal { 
  position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; 
  background: var(--bg-card); color: var(--text-main);
  z-index: 200; border-radius: 8px; display: none; flex-direction: column; 
  border: 1px solid var(--border-color);
}
.chart-container { width: 100%; max-width: 300px; margin: 0 auto 20px auto; }

/* TELEGRAM POPUP */
#tgPopup{
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background: var(--bg-card); padding:25px; width:85%; max-width:320px;
  border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.4);
  z-index:9999; text-align:center; display:none; color: var(--text-main);
  border: 1px solid var(--border-color);
}
#tgPopup a{ display:block; background:#0088cc; color:#fff; padding:12px; border-radius:8px; text-decoration:none; margin-top:15px; font-weight:bold; }
.tg-btn-continue { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; margin-top: 15px; cursor: pointer; font-weight: 600; }

/* ZOOM MODAL */
#zoomModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--zoom-bg); z-index: 5000;
    display: none; justify-content: center; align-items: center;
    flex-direction: column;
}
#zoomImg {
    max-width: 90%; max-height: 85vh; border-radius: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: 1px solid #fff;
}
.close-zoom {
    position: absolute; top: 20px; right: 20px;
    font-size: 40px; color: var(--text-main); cursor: pointer; font-weight: bold;
}

/* Result Question Box Styling (for PDF) */
.result-q-box {
    margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color);
    border-radius: 6px; background: var(--bg-card);
    page-break-inside: avoid;
}
.res-opt {
    padding: 5px; margin: 2px 0; border-radius: 4px; font-size: 14px;
}
.res-opt.c { background: rgba(46, 125, 50, 0.2); border: 1px solid var(--success); }
.res-opt.w { background: rgba(198, 40, 40, 0.2); border: 1px solid var(--danger); text-decoration: line-through; }

/* Responsive */
@media(min-width: 768px) {
  body { grid-template-columns: 1fr 300px; grid-template-rows: auto auto 1fr; }
  header { grid-column: 1 / -1; }
  #subHeader { grid-column: 1 / 2; }
  #mainArea { grid-column: 1 / 2; grid-row: 3 / 4; padding-bottom: 20px; }
  #palettePanel {
    position: static; width: auto; height: auto; right: auto;
    grid-column: 2 / 3; grid-row: 2 / 4;
    border-left: 1px solid var(--border-color); box-shadow: none; z-index: 1;
  }
  footer {
    grid-column: 1 / 2; position: static;
    display: flex; justify-content: space-between;
    box-shadow: none; border-top: 1px solid var(--border-color);
  }
  .btn-palette { display: none; } 
  .p-grid { grid-template-columns: repeat(4, 1fr); }
  #qpModal { width: 60%; left: 20%; }
}
</style>
</head>

<body onload="initApp()">

<div id="zoomModal" onclick="closeZoom()">
    <span class="close-zoom">&times;</span>
    <img id="zoomImg" src="">
    <div style="color:var(--text-main); margin-top:10px;">Click anywhere to close</div>
</div>

<div id="startScreen" class="full-screen-overlay">
    <div class="start-card">
        <h2 style="color:var(--primary); margin-top:0;">Sectional Mock Test</h2>
        <p style="color:var(--text-muted)">Please enter your name to proceed.</p>
        <input type="text" id="startNameInput" class="start-input" placeholder="Enter Full Name">
        <button class="primary-btn" onclick="goToInstructions()">NEXT</button>
    </div>
</div>

<div id="instScreen" class="full-screen-overlay" style="display:none;">
    <div class="start-card" style="max-width:600px; text-align:left;">
        <h3 style="color:var(--primary); border-bottom:1px solid var(--border-color); padding-bottom:10px;">General Instructions</h3>
        <div class="inst-list">
            <b>Subject: English Language (Single Section)</b><br>
            <b>Marking Scheme:</b>
            <ul>
                <li style="color:var(--success)">Correct Answer: +1 Mark</li>
                <li style="color:var(--danger)">Wrong Answer: -0.25 Mark</li>
            </ul>
        </div>
        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600; font-size:14px; margin-top:20px;">
            <input type="checkbox" id="instCheck" onchange="toggleStartBtn()" style="width:20px; height:20px; margin-right:10px;">
            I have read and understood the instructions.
        </label>
        <br>
        <button id="finalStartBtn" class="primary-btn" onclick="startTestFlow()" disabled>I AM READY TO BEGIN</button>
    </div>
</div>

<div id="resumeScreen" class="full-screen-overlay" style="display:none;">
    <div class="start-card">
        <h3 style="color:var(--primary);">Test In Progress Found</h3>
        <p style="color:var(--text-muted);">We found a previous unfinished session for <b id="resumeName"></b>.</p>
        <div style="background:var(--bg-body); padding:10px; margin:10px 0; border-radius:5px;">
            <small>Last active: <span id="resumeTime"></span> mins elapsed</small>
        </div>
        <button class="primary-btn" onclick="resumeTest()">RESUME SESSION</button>
        <button class="secondary-btn" onclick="startNewTest()">START FRESH</button>
    </div>
</div>

<div id="tgPopup">
 <b>üì¢ Join DSSSB Smart Notes</b><br><br>
 Daily CBT Tests ‚Ä¢ PDFs ‚Ä¢ Results
 <a href="https://t.me/DSSSBSmartNotes" target="_blank">Join Telegram</a><br>
 <button class="tg-btn-continue" onclick="closeTg()">Continue Test</button>
</div>

<div class="overlay" onclick="togglePalette()" id="bgOverlay"></div>

<header>
  <div class="brand">DSSSB Mock <span style="font-size:0.8em; color:var(--text-muted)">v2.7</span></div>
  <div style="display:flex; align-items:center; gap:10px;">
    <div id="timer">00:00</div>
    <button class="tool-btn" onclick="pauseTest()" style="color:var(--warning); border-color:var(--warning)">‚è∏ Pause</button>
    <button class="tool-btn" onclick="toggleDarkMode()" id="themeBtn">üåô</button>
    <button class="tool-btn" onclick="toggleLang()" id="langBtn">EN/HI</button>
    <button class="tool-btn" onclick="toggleFS()">‚õ∂</button>
    <button class="tool-btn" onclick="openQP()">üìÑ Paper</button>
  </div>
</header>

<div id="subHeader">English Language</div>

<div id="mainArea">
  <input type="hidden" id="stuName">
  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:var(--text-muted); font-size:13px;">
      <span>Question No. <b id="qNumDisp">1</b></span>
      <span style="display:flex; gap:10px;">
        <span style="color:var(--success)">+1.00</span>
        <span style="color:var(--danger)">-0.25</span>
      </span>
    </div>
    <div style="font-size:14px; text-align:right; margin-bottom:5px;">
        <button class="tool-btn" onclick="changeFont(1)">A+</button>
        <button class="tool-btn" onclick="changeFont(-1)">A-</button>
    </div>
    <div id="qContent"></div> 
    <div id="opts"></div>      
    <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
        <button class="tool-btn" style="color:orange; border:1px solid orange; background:var(--bg-card)" onclick="markReview()">‚≠ê Mark for Review</button>
        <button class="tool-btn" style="color:var(--text-muted);" onclick="clearResponse()">Borrar (Clear)</button>
    </div>
    <div id="expBox"></div>
    <button id="expBtn" onclick="toggleExp()" style="width:100%; padding:10px; margin-top:10px; background:var(--primary); border:none; border-radius:4px; display:none; color:#fff; font-weight:bold;">View Solution</button>
  </div>
</div>

<div id="palettePanel">
  <div class="p-header">
    <b>Question Palette</b>
    <button onclick="togglePalette()" style="border:none; background:none; font-size:20px; cursor:pointer; color:var(--text-main)" class="close-pal">&times;</button>
  </div>
  <div style="padding:10px; background:var(--bg-card); font-size:12px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
    <div style="display:flex; align-items:center; gap:5px;"><div class="qbtn answered" style="width:20px; height:20px;"></div> Answered</div>
    <div style="display:flex; align-items:center; gap:5px;"><div class="qbtn visited" style="width:20px; height:20px;"></div> Not Answered</div>
    <div style="display:flex; align-items:center; gap:5px;"><div class="qbtn review" style="width:20px; height:20px;"></div> Mark Review</div>
    <div style="display:flex; align-items:center; gap:5px;"><div class="qbtn" style="width:20px; height:20px;"></div> Not Visited</div>
  </div>
  <div class="p-grid" id="paletteGrid"></div>
  <div class="p-footer">
    <button onclick="submitTest()" style="width:100%; padding:12px; background:var(--success); color:#fff; border:none; border-radius:4px; font-weight:bold; font-size:16px;">SUBMIT TEST</button>
  </div>
</div>

<footer>
  <button class="nav-btn btn-palette" onclick="togglePalette()">Grid</button>
  <button class="nav-btn btn-prev" onclick="prev()">Previous</button>
  <button class="nav-btn btn-next" onclick="next()">Next</button>
</footer>

<div id="qpModal">
    <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
        <b id="modalTitle">Full Question Paper</b>
        <button onclick="closeQP()" style="border:none; background:none; font-size:20px; color:var(--text-main)">&times;</button>
    </div>
    <div id="qpContent" style="padding:20px; overflow-y:auto; flex:1;"></div>
</div>

<script>
/* DATA & CONFIG */
const SECTION_NAME = "English Language"; 
const NEGATIVE_MARK = 0.25;
const TELEGRAM_BOT_TOKEN="8486464606:AAFT_Bd0P2HYqKNPjCm3s7TGgfM4HWmOYvs";
const TELEGRAM_CHAT_ID="@dsssbcbtresult";

/* SECTIONAL QUESTIONS ONLY (English) */
const QUESTIONS = [
  { 
      id: 1, 
      q_hi: "Select the most appropriate option to fill in the blank.<br>The train ______ before we reached the station.", 
      q_en: "Select the most appropriate option to fill in the blank.<br>The train ______ before we reached the station.", 
      o_hi: ["left", "has left", "had left", "was leaving"], 
      o_en: ["left", "has left", "had left", "was leaving"], 
      a: 2, 
      e_hi: "Past Perfect Tense is used to demonstrate an action that occurred before another action in the past. Structure: Subject + had + V3.",
      e_en: "Past Perfect Tense is used to demonstrate an action that occurred before another action in the past. Structure: Subject + had + V3."
  },
  { 
      id: 2, 
      q_hi: "Identify the segment in the sentence which contains a grammatical error.<br>One of the boys are playing in the garden.", 
      q_en: "Identify the segment in the sentence which contains a grammatical error.<br>One of the boys are playing in the garden.", 
      o_hi: ["One of the", "boys", "are playing", "in the garden"], 
      o_en: ["One of the", "boys", "are playing", "in the garden"], 
      a: 2, 
      e_hi: "'One of the + Plural Noun' takes a Singular Verb. 'Are' should be replaced with 'Is'.",
      e_en: "'One of the + Plural Noun' takes a Singular Verb. 'Are' should be replaced with 'Is'."
  },
  { 
      id: 3, 
      q_hi: "Select the synonym of the given word:<br><b>ABANDON</b>", 
      q_en: "Select the synonym of the given word:<br><b>ABANDON</b>", 
      o_hi: ["Keep", "Cherish", "Forsake", "Enlarge"], 
      o_en: ["Keep", "Cherish", "Forsake", "Enlarge"], 
      a: 2, 
      e_hi: "Abandon means to leave or give up completely. Synonyms: Forsake, Desert, Renounce.",
      e_en: "Abandon means to leave or give up completely. Synonyms: Forsake, Desert, Renounce."
  },
  { 
      id: 4, 
      q_hi: "Select the meaning of the given idiom:<br><b>To break the ice</b>", 
      q_en: "Select the meaning of the given idiom:<br><b>To break the ice</b>", 
      o_hi: ["To start a conversation", "To cool down", "To break something expensive", "To make enemies"], 
      o_en: ["To start a conversation", "To cool down", "To break something expensive", "To make enemies"], 
      a: 0, 
      e_hi: "'To break the ice' means to do or say something to relieve tension or start a conversation in a social setting.",
      e_en: "'To break the ice' means to do or say something to relieve tension or start a conversation in a social setting."
  },
  
  // COMPREHENSION PASSAGE QUESTIONS (Passage embedded in each question)
  {
      id: 5,
      q_hi: "<div class='passage-box'><b>Passage:</b><br>The Amazon rainforest is the world's largest tropical rainforest. It covers much of northwestern Brazil and extends into Colombia, Peru, and other South American countries. The Amazon is famous for its biodiversity. It is crisscrossed by thousands of rivers, including the powerful Amazon River. It is often referred to as the 'lungs of the planet' because it produces 20% of the world's oxygen.</div><br><b>SubQuestion No: 1</b><br>Why is the Amazon rainforest referred to as the 'lungs of the planet'?",
      q_en: "<div class='passage-box'><b>Passage:</b><br>The Amazon rainforest is the world's largest tropical rainforest. It covers much of northwestern Brazil and extends into Colombia, Peru, and other South American countries. The Amazon is famous for its biodiversity. It is crisscrossed by thousands of rivers, including the powerful Amazon River. It is often referred to as the 'lungs of the planet' because it produces 20% of the world's oxygen.</div><br><b>SubQuestion No: 1</b><br>Why is the Amazon rainforest referred to as the 'lungs of the planet'?",
      o_hi: ["It has many rivers", "It covers a large area", "It produces 20% of the world's oxygen", "It is in South America"],
      o_en: ["It has many rivers", "It covers a large area", "It produces 20% of the world's oxygen", "It is in South America"],
      a: 2,
      e_hi: "The passage explicitly states: 'It is often referred to as the lungs of the planet because it produces 20% of the world's oxygen.'",
      e_en: "The passage explicitly states: 'It is often referred to as the lungs of the planet because it produces 20% of the world's oxygen.'"
  },
  {
      id: 6,
      q_hi: "<div class='passage-box'><b>Passage:</b><br>The Amazon rainforest is the world's largest tropical rainforest. It covers much of northwestern Brazil and extends into Colombia, Peru, and other South American countries. The Amazon is famous for its biodiversity. It is crisscrossed by thousands of rivers, including the powerful Amazon River. It is often referred to as the 'lungs of the planet' because it produces 20% of the world's oxygen.</div><br><b>SubQuestion No: 2</b><br>Which river is specifically mentioned in the passage?",
      q_en: "<div class='passage-box'><b>Passage:</b><br>The Amazon rainforest is the world's largest tropical rainforest. It covers much of northwestern Brazil and extends into Colombia, Peru, and other South American countries. The Amazon is famous for its biodiversity. It is crisscrossed by thousands of rivers, including the powerful Amazon River. It is often referred to as the 'lungs of the planet' because it produces 20% of the world's oxygen.</div><br><b>SubQuestion No: 2</b><br>Which river is specifically mentioned in the passage?",
      o_hi: ["Nile River", "Amazon River", "Ganga River", "Mississippi River"],
      o_en: ["Nile River", "Amazon River", "Ganga River", "Mississippi River"],
      a: 1,
      e_hi: "The passage mentions: '...including the powerful Amazon River.'",
      e_en: "The passage mentions: '...including the powerful Amazon River.'"
  }
];

/* STATE */
let currentIdx = 0;
let currentLang = "EN"; // Default to English for English Section
let answers = new Array(QUESTIONS.length).fill(null);
let reviewStatus = new Array(QUESTIONS.length).fill(false);
let visitedStatus = new Array(QUESTIONS.length).fill(false);
let submitted = false;
let timeElapsed = 0;
let fontSize = 16;
let isDarkMode = false;
let timerInterval;

/* INIT LOGIC */
function initApp() {
    if(localStorage.getItem('dsssb_dark_mode') === 'true') toggleDarkMode();
    const saved = localStorage.getItem('dsssb_cbt_state_eng');
    if(saved) {
        const s = JSON.parse(saved);
        if(s.submitted) { 
            document.getElementById('startScreen').style.display = 'flex';
        } else {
            document.getElementById('resumeName').innerText = s.name || "Student";
            document.getElementById('resumeTime').innerText = Math.floor((s.time || 0) / 60);
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('resumeScreen').style.display = 'flex';
        }
    } else {
        document.getElementById('startScreen').style.display = 'flex';
    }
}

function startNewTest() { localStorage.removeItem('dsssb_cbt_state_eng'); location.reload(); }
function resumeTest() { document.getElementById('resumeScreen').style.display = 'none'; initExam(); }
function pauseTest() { if(submitted) return; saveState(); clearInterval(timerInterval); alert("Paused! You can resume later."); location.reload(); }

function goToInstructions() {
    const name = document.getElementById('startNameInput').value.trim();
    if(!name) { alert("Enter Name!"); return; }
    document.getElementById('stuName').value = name;
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('instScreen').style.display = 'flex';
}

function toggleStartBtn() { document.getElementById('finalStartBtn').disabled = !document.getElementById('instCheck').checked; }
function startTestFlow() { document.getElementById('instScreen').style.display = 'none'; initExam(); }

function initExam() {
  document.getElementById('mainArea').style.display = 'block';
  document.querySelector('footer').style.display = 'flex';
  document.getElementById('tgPopup').style.display = "block";
  loadState(); loadQuestion(currentIdx); startTimer();
  document.addEventListener('keydown', (e) => { if(e.key === "ArrowRight") next(); if(e.key === "ArrowLeft") prev(); });
}

function closeTg(){ document.getElementById('tgPopup').style.display = "none"; }

/* LOGIC */
function saveState() {
  if(submitted) return;
  const state = {
    idx: currentIdx, ans: answers, rev: reviewStatus, vis: visitedStatus,
    time: timeElapsed, name: document.getElementById('stuName').value, submitted: false
  };
  localStorage.setItem('dsssb_cbt_state_eng', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('dsssb_cbt_state_eng');
  if(saved) {
    const s = JSON.parse(saved);
    currentIdx = s.idx || 0; answers = s.ans || answers;
    reviewStatus = s.rev || reviewStatus; visitedStatus = s.vis || visitedStatus;
    timeElapsed = s.time || 0;
    document.getElementById('stuName').value = s.name || "";
  }
}

function loadQuestion(idx) {
  currentIdx = idx; visitedStatus[idx] = true; saveState(); 
  
  const q = QUESTIONS[idx];
  document.getElementById('qNumDisp').innerText = idx + 1;
  const txt = (currentLang === "HI" && q.q_hi) ? q.q_hi : (q.q_en || q.q_hi);
  
  // Render text
  const contentDiv = document.getElementById('qContent');
  contentDiv.innerHTML = txt;
  contentDiv.style.fontSize = fontSize + "px";
  
  // AUTO-ENABLE ZOOM
  const imgs = contentDiv.querySelectorAll('img');
  imgs.forEach(img => {
      img.classList.add('q-img');
      img.onclick = () => openZoom(img.src);
  });
  
  const optsArr = (currentLang === "HI" && q.o_hi) ? q.o_hi : (q.o_en || q.o_hi);
  let html = "";
  optsArr.forEach((opt, i) => {
    let cls = "opt";
    if(submitted) { if(i === q.a) cls += " correct"; else if(answers[idx] === i) cls += " wrong"; } 
    else { if(answers[idx] === i) cls += " sel"; }
    html += `<div class="${cls}" onclick="selectAnswer(${i})"><div class="opt-circle">${String.fromCharCode(65+i)}</div><div>${opt}</div></div>`;
  });
  document.getElementById('opts').innerHTML = html;
  renderPalette();
  if(window.MathJax) MathJax.typesetPromise();
  if(submitted) {
    const expText = (currentLang === "HI" && q.e_hi) ? q.e_hi : (q.e_en || q.e_hi);
    document.getElementById('expBox').innerHTML = "<b>Explanation:</b><br>" + (expText || "No explanation.");
    document.getElementById('expBtn').style.display = "block";
  }
}

/* ZOOM FUNCTIONS */
function openZoom(src) {
    document.getElementById('zoomImg').src = src;
    document.getElementById('zoomModal').style.display = 'flex';
}
function closeZoom() {
    document.getElementById('zoomModal').style.display = 'none';
}

function renderPalette() {
  const grid = document.getElementById('paletteGrid'); grid.innerHTML = "";
  QUESTIONS.forEach((q, k) => {
    let cls = "qbtn"; if(k === currentIdx) cls += " current";
    if(submitted) { if(answers[k] === q.a) cls += " answered"; else if(answers[k] !== null) cls += " wrong"; } 
    else { if(reviewStatus[k] && answers[k] !== null) cls += " review-ans"; else if(reviewStatus[k]) cls += " review"; else if(answers[k] !== null) cls += " answered"; else if(visitedStatus[k]) cls += " visited"; }
    const btn = document.createElement('button'); btn.className = cls; btn.innerText = k + 1;
    btn.onclick = () => { loadQuestion(k); if(window.innerWidth < 768) togglePalette(); };
    grid.appendChild(btn);
  });
}

function selectAnswer(i) { if(!submitted) { answers[currentIdx] = i; loadQuestion(currentIdx); } }
function clearResponse() { if(!submitted) { answers[currentIdx] = null; reviewStatus[currentIdx]=false; loadQuestion(currentIdx); } }
function markReview() { if(!submitted) { reviewStatus[currentIdx] = !reviewStatus[currentIdx]; loadQuestion(currentIdx); } }
function next() { if(currentIdx < QUESTIONS.length - 1) loadQuestion(currentIdx + 1); }
function prev() { if(currentIdx > 0) loadQuestion(currentIdx - 1); }
function toggleLang() { currentLang = currentLang === "HI" ? "EN" : "HI"; document.getElementById('langBtn').innerText = currentLang; loadQuestion(currentIdx); }
function changeFont(d) { fontSize += d; document.getElementById('qContent').style.fontSize = fontSize + "px"; }
function toggleDarkMode() { isDarkMode = !isDarkMode; document.body.classList.toggle('dark-mode'); document.getElementById('themeBtn').innerText = isDarkMode ? "‚òÄÔ∏è" : "üåô"; localStorage.setItem('dsssb_dark_mode', isDarkMode); }

/* ================== SUBMIT & RESULT GENERATION ================== */
function submitTest() {
  const name = document.getElementById('stuName').value;
  if(!confirm("Are you sure you want to submit?")) return;
  
  submitted = true; clearInterval(timerInterval); localStorage.removeItem('dsssb_cbt_state_eng'); 
  let scoreData = { c:0, w:0, s:0 };
  let totalScore = 0;

  QUESTIONS.forEach((q, i) => {
    if(answers[i] === null) { scoreData.s++; }
    else if(answers[i] === q.a) { scoreData.c++; totalScore++; }
    else { scoreData.w++; totalScore -= NEGATIVE_MARK; }
  });

  let attempted = scoreData.c + scoreData.w;
  let accuracy = attempted ? ((scoreData.c/attempted)*100) : 0;
  let rankScore = (totalScore*100) + accuracy;
  let estRank = Math.max(1, Math.round(1000 - rankScore));
  let timeStr = document.getElementById('timer').innerText;

  /* --- 1. SCORE CARD HTML --- */
  document.getElementById('modalTitle').innerText = "Score Card";
  let resHTML = `
  <div style="text-align:center;">
    <h3>${name}, Test Submitted!</h3>
    <div style="font-size:24px; color:var(--primary);">Score: <b>${totalScore.toFixed(2)}</b></div>
    <div class="chart-container"><canvas id="resultChart"></canvas></div>
  </div>
  <table border="1" style="width:100%; border-collapse:collapse; text-align:center; font-size:14px; border-color:var(--border-color); margin-bottom:20px;">
    <tr style="background:var(--bg-body)"><th>Section</th><th>‚úÖ</th><th>‚ùå</th><th>‚ö™</th></tr>
    <tr><td>${SECTION_NAME}</td><td style="color:var(--success)">${scoreData.c}</td><td style="color:var(--danger)">${scoreData.w}</td><td>${scoreData.s}</td></tr>
  </table>`;

  /* --- 2. FULL PAPER HTML --- */
  resHTML += `<h3 style="border-top:1px solid #ccc; padding-top:20px;">Response Sheet</h3>`;
  QUESTIONS.forEach((q, i) => {
      const isCorrect = answers[i] === q.a;
      const statusColor = answers[i] === null ? '#999' : (isCorrect ? 'green' : 'red');
      const statusText = answers[i] === null ? 'Skipped' : (isCorrect ? 'Correct' : 'Wrong');
      const qText = (currentLang === "HI" && q.q_hi) ? q.q_hi : (q.q_en || q.q_hi);
      const opts = (currentLang === "HI" && q.o_hi) ? q.o_hi : (q.o_en || q.o_hi);
      const exp = (currentLang === "HI" && q.e_hi) ? q.e_hi : (q.e_en || q.e_hi);

      resHTML += `<div class="result-q-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <b>Q.${i+1}</b>
            <b style="color:${statusColor}">${statusText}</b>
        </div>
        <div style="margin-bottom:10px;">${qText}</div>
        <div>`;
       
      opts.forEach((opt, k) => {
          let optClass = "res-opt";
          if(k === q.a) optClass += " c"; // Correct Answer
          if(k === answers[i] && k !== q.a) optClass += " w"; // User Wrong Answer
          resHTML += `<div class="${optClass}">${String.fromCharCode(65+k)}. ${opt}</div>`;
      });
      
      resHTML += `</div><div style="margin-top:5px; font-size:13px; color:#555; background:#f9f9f9; padding:5px;"><b>Exp:</b> ${exp}</div></div>`;
  });

  /* --- 3. ACTION BUTTONS --- */
  resHTML += `
  <div style="display:flex; gap:10px; justify-content:center; padding-bottom:30px;">
    <button class="tool-btn" onclick="downloadPDF()" style="background:var(--primary); color:#fff; border:none; padding:10px 20px;">üì• Download Result</button>
    <button class="tool-btn" onclick="location.reload()" style="background:var(--success); color:#fff; border:none; padding:10px 20px;">Restart Test</button>
  </div>`;

  document.getElementById('qpContent').innerHTML = resHTML;
  document.getElementById('qpModal').style.display = "flex";
  
  renderChart(scoreData.c, scoreData.w, scoreData.s);
  if(window.MathJax) MathJax.typesetPromise();
  sendResultToTelegram(name, totalScore.toFixed(2), scoreData.c, scoreData.w, scoreData.s, timeStr, accuracy, estRank);
  loadQuestion(currentIdx);
}

function renderChart(c, w, s) {
    const ctx = document.getElementById('resultChart').getContext('2d');
    const txtColor = isDarkMode ? '#e0e0e0' : '#333';
    new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Correct', 'Wrong', 'Skipped'], datasets: [{ data: [c, w, s], backgroundColor: ['#2e7d32', '#c62828', '#bdbdbd'], borderWidth: 0 }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: txtColor } } } }
    });
}

function downloadPDF() {
    const element = document.getElementById('qpContent');
    const btns = element.querySelectorAll('button');
    btns.forEach(b => b.style.display = 'none'); // Hide buttons
    const opt = {
        margin: 5, filename: 'Sectional_Mock_Result.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save().then(() => {
        btns.forEach(b => b.style.display = 'inline-block'); // Show buttons
    });
}

function sendResultToTelegram(name,score,c,w,s,time,accuracy,estRank){
 fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
  method:"POST", headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
   chat_id:TELEGRAM_CHAT_ID,
   text:`üìò DSSSB Sectional Mock (English)\n\nüë§ Name: ${name}\n‚è± Time: ${time}\n‚úÖ Correct: ${c}\n‚ùå Wrong: ${w}\n‚ûñ Skipped: ${s}\nüéØ Score: ${score}\nüìä Accuracy: ${accuracy.toFixed(2)}%\n\nüî• DSSSB Smart Notes`
  })
 });
}

/* UTILS */
function startTimer() {
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeElapsed++;
    const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
    const s = (timeElapsed % 60).toString().padStart(2, '0');
    document.getElementById('timer').innerText = `${m}:${s}`;
  }, 1000);
}
function togglePalette() { document.getElementById('palettePanel').classList.toggle('show'); document.getElementById('bgOverlay').classList.toggle('show'); }
function toggleFS() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
function toggleExp() { const b=document.getElementById('expBox'); b.style.display = b.style.display==="none"?"block":"none"; }
function openQP() {
  document.getElementById('modalTitle').innerText = "Full Question Paper";
  let html = "";
  QUESTIONS.forEach((q, i) => {
    html += `<div style="margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
        <b>Q.${i+1}</b><br>${(currentLang==="HI"?q.q_hi:q.q_en) || q.q_hi}<br>
        <i style="color:var(--text-muted); font-size:0.9em">Options: ${(currentLang==="HI"?q.o_hi:q.o_en).join(', ')}</i>
    </div>`;
  });
  document.getElementById('qpContent').innerHTML = html;
  document.getElementById('qpModal').style.display = "flex";
}
function closeQP() { document.getElementById('qpModal').style.display = "none"; }
</script>
</body>
</html>
